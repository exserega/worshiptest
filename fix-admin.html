<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #ff6b6b;
            margin-bottom: 30px;
        }
        .info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .button:hover {
            background: #ff5252;
        }
        .user-info {
            margin: 10px 0;
            padding: 10px;
            background: #444;
            border-radius: 5px;
        }
        pre {
            background: #111;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
        
        <div id="status"></div>
        <div id="content"></div>
        
        <div style="margin-top: 30px;">
            <button class="button" onclick="checkSystem()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
            <button class="button" onclick="restoreAdmin()">üëë –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω–∞</button>
            <button class="button" onclick="forceSetAdmin()">‚ö° –§–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞</button>
            <button class="button" onclick="window.location.href='/'">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzDxg3S9cfseoozmZSksUh1aLbkVBG--Q",
            authDomain: "song-archive-389a6.firebaseapp.com",
            projectId: "song-archive-389a6",
            storageBucket: "song-archive-389a6.appspot.com",
            messagingSenderId: "660585697058",
            appId: "1:660585697058:web:7ceacf752ce6b21ad8fb40"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const targetUserId = 'AF5iJmVy9cd6Hat9QNxygij0RFS2';
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
        }
        
        async function checkSystem() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = '<div class="info">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</div>';
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const currentUser = auth.currentUser;
                let html = '<h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:</h3>';
                
                if (currentUser) {
                    html += `<div class="user-info">
                        <strong>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong><br>
                        ID: ${currentUser.uid}<br>
                        Email: ${currentUser.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                        Phone: ${currentUser.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </div>`;
                } else {
                    html += '<div class="error">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userDoc = await db.collection('users').doc(targetUserId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    html += `<div class="user-info">
                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetUserId}:</strong><br>
                        <pre>${JSON.stringify(userData, null, 2)}</pre>
                    </div>`;
                } else {
                    html += `<div class="error">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${targetUserId} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</div>`;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–¥–º–∏–Ω–æ–≤
                const adminsSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .get();
                    
                html += `<div class="info">
                    <strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≤ —Å–∏—Å—Ç–µ–º–µ:</strong> ${adminsSnapshot.size}
                </div>`;
                
                if (adminsSnapshot.size > 0) {
                    html += '<div class="user-info"><strong>–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤:</strong><br>';
                    adminsSnapshot.forEach(doc => {
                        const admin = doc.data();
                        html += `- ${doc.id}: ${admin.name || admin.email || '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${admin.status})<br>`;
                    });
                    html += '</div>';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const firstUserSnapshot = await db.collection('users')
                    .orderBy('createdAt', 'asc')
                    .limit(1)
                    .get();
                    
                if (!firstUserSnapshot.empty) {
                    const firstUser = firstUserSnapshot.docs[0];
                    html += `<div class="info">
                        <strong>–ü–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã:</strong><br>
                        ID: ${firstUser.id}<br>
                        ${firstUser.id === targetUserId ? '‚úÖ –≠—Ç–æ —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '‚ùå –≠—Ç–æ –ù–ï —Ü–µ–ª–µ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                    </div>`;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª–∏–∞–ª—ã
                const branchesSnapshot = await db.collection('branches').get();
                html += `<div class="info">
                    <strong>–§–∏–ª–∏–∞–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ:</strong> ${branchesSnapshot.size}
                </div>`;
                
                contentDiv.innerHTML = html;
                showStatus('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function restoreAdmin() {
            if (!confirm(`–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${targetUserId}?`)) {
                return;
            }
            
            showStatus('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...', 'info');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userDoc = await db.collection('users').doc(targetUserId).get();
                if (!userDoc.exists) {
                    throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                }
                
                const userData = userDoc.data();
                console.log('Current user data:', userData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º —Ñ–∏–ª–∏–∞–ª
                let branchId = userData.branchId || null;
                
                if (!branchId) {
                    const branchesSnapshot = await db.collection('branches').limit(1).get();
                    
                    if (branchesSnapshot.empty) {
                        // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∏–ª–∏–∞–ª
                        const branchData = {
                            name: '–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª–∏–∞–ª',
                            location: '–ì–ª–∞–≤–Ω—ã–π –æ—Ñ–∏—Å',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            createdBy: targetUserId,
                            memberCount: 1,
                            isDefault: true
                        };
                        
                        const branchRef = await db.collection('branches').add(branchData);
                        branchId = branchRef.id;
                        console.log('Created branch:', branchId);
                    } else {
                        branchId = branchesSnapshot.docs[0].id;
                        console.log('Using existing branch:', branchId);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–¥–º–∏–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ
                const adminsSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .where('status', '==', 'active')
                    .get();
                
                const hasActiveAdmins = !adminsSnapshot.empty;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const updateData = {
                    role: 'admin',
                    status: 'active',
                    branchId: branchId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–¥–º–∏–Ω–æ–≤, –¥–µ–ª–∞–µ–º —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≥–ª–∞–≤–Ω—ã–º
                if (!hasActiveAdmins) {
                    updateData.isFounder = true;
                    updateData.isRootAdmin = true;
                    console.log('No active admins found, setting as root admin');
                }
                
                await db.collection('users').doc(targetUserId).update(updateData);
                
                showStatus('‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Ñ–∏–ª–∏–∞–ª–∞
                if (branchId && !userData.branchId) {
                    await db.collection('branches').doc(branchId).update({
                        memberCount: firebase.firestore.FieldValue.increment(1)
                    });
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                setTimeout(() => checkSystem(), 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        async function forceSetAdmin() {
            if (!confirm(`–í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–¥–µ–ª–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${targetUserId} –≥–ª–∞–≤–Ω—ã–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
                return;
            }
            
            showStatus('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞...', 'info');
            
            try {
                // –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥–∏ –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ —É –≤—Å–µ—Ö
                const adminsSnapshot = await db.collection('users')
                    .where('role', '==', 'admin')
                    .get();
                    
                const batch = db.batch();
                
                adminsSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        isFounder: false,
                        isRootAdmin: false
                    });
                });
                
                await batch.commit();
                console.log('Cleared all root admin flags');
                
                // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º/—Å–æ–∑–¥–∞–µ–º —Ñ–∏–ª–∏–∞–ª
                let branchId = null;
                const branchesSnapshot = await db.collection('branches').limit(1).get();
                
                if (branchesSnapshot.empty) {
                    // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∏–ª–∏–∞–ª
                    const branchData = {
                        name: '–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∏–ª–∏–∞–ª',
                        location: '–ì–ª–∞–≤–Ω—ã–π –æ—Ñ–∏—Å',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: targetUserId,
                        memberCount: 1,
                        isDefault: true
                    };
                    
                    const branchRef = await db.collection('branches').add(branchData);
                    branchId = branchRef.id;
                    console.log('Created branch:', branchId);
                } else {
                    branchId = branchesSnapshot.docs[0].id;
                }
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–∞–≤–∞
                await db.collection('users').doc(targetUserId).set({
                    role: 'admin',
                    status: 'active',
                    branchId: branchId,
                    isFounder: true,
                    isRootAdmin: true,
                    email: '19exxtazzy96@gmail.com',
                    name: '–ì–ª–∞–≤–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showStatus('‚úÖ –ü—Ä–∞–≤–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!', 'success');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                setTimeout(() => checkSystem(), 1000);
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        auth.onAuthStateChanged((user) => {
            if (user) {
                checkSystem();
            } else {
                showStatus('‚ö†Ô∏è –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è', 'error');
                const contentDiv = document.getElementById('content');
                contentDiv.innerHTML = '<button class="button" onclick="window.location.href=\'/login.html\'">–í–æ–π—Ç–∏</button>';
            }
        });
    </script>
</body>
</html>