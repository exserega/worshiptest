<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ Firestore</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            max-width: 800px;
            margin: 0 auto;
        }
        .test {
            margin: 20px 0;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
        pre {
            background: #111;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firestore</h1>
    
    <div class="test">
        <h2>1. Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</h2>
        <div id="firebase-test">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
    </div>
    
    <div class="test">
        <h2>2. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
        <div id="auth-test">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
    </div>
    
    <div class="test">
        <h2>3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firestore</h2>
        <div id="firestore-test">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
    </div>
    
    <div class="test">
        <h2>4. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <div id="read-test">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
    </div>
    
    <div class="test">
        <h2>5. –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h2>
        <div id="rules-test">–ü—Ä–æ–≤–µ—Ä–∫–∞...</div>
        <pre id="rules-info"></pre>
    </div>
    
    <div style="margin-top: 20px;">
        <button onclick="runAllTests()">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
        <button onclick="window.location.href='/'">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzDxg3S9cfseoozmZSksUh1aLbkVBG--Q",
            authDomain: "song-archive-389a6.firebaseapp.com",
            projectId: "song-archive-389a6",
            storageBucket: "song-archive-389a6.appspot.com",
            messagingSenderId: "660585697058",
            appId: "1:660585697058:web:7ceacf752ce6b21ad8fb40"
        };

        let auth, db;
        
        // Test 1: Firebase initialization
        function testFirebaseInit() {
            const div = document.getElementById('firebase-test');
            try {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –ø—Ä–æ–±–ª–µ–º —Å —Å–µ—Ç—å—é
                db.settings({
                    experimentalForceLongPolling: true,
                    merge: true
                });
                
                div.innerHTML = '<span class="success">‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ</span>';
                return true;
            } catch (error) {
                div.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`;
                return false;
            }
        }
        
        // Test 2: Authentication
        async function testAuth() {
            const div = document.getElementById('auth-test');
            return new Promise((resolve) => {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        div.innerHTML = `<span class="success">‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.email || user.phoneNumber}</span>`;
                        resolve(true);
                    } else {
                        div.innerHTML = '<span class="error">‚ùå –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>';
                        resolve(false);
                    }
                });
            });
        }
        
        // Test 3: Firestore connection
        async function testFirestoreConnection() {
            const div = document.getElementById('firestore-test');
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
                await db.collection('_test_').doc('test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                div.innerHTML = '<span class="success">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firestore —Ä–∞–±–æ—Ç–∞–µ—Ç</span>';
                
                // –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
                await db.collection('_test_').doc('test').delete();
                return true;
            } catch (error) {
                div.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</span>`;
                console.error('Firestore connection error:', error);
                return false;
            }
        }
        
        // Test 4: Read user data
        async function testReadUserData() {
            const div = document.getElementById('read-test');
            const user = auth.currentUser;
            
            if (!user) {
                div.innerHTML = '<span class="error">‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>';
                return false;
            }
            
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    div.innerHTML = `<span class="success">‚úÖ –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—á–∏—Ç–∞–Ω—ã: ${JSON.stringify(data)}</span>`;
                    return true;
                } else {
                    div.innerHTML = '<span class="info">‚ö†Ô∏è –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω</span>';
                    return false;
                }
            } catch (error) {
                div.innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}</span>`;
                return false;
            }
        }
        
        // Test 5: Security rules info
        async function testSecurityRules() {
            const div = document.getElementById('rules-test');
            const info = document.getElementById('rules-info');
            
            const rulesInfo = `
–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞ Firestore –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users
    match /users/{userId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
    }
    
    // –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
    match /{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}`;
            
            div.innerHTML = '<span class="info">‚ÑπÔ∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ Firebase Console</span>';
            info.textContent = rulesInfo;
        }
        
        // Run all tests
        async function runAllTests() {
            // Test 1
            if (!testFirebaseInit()) return;
            
            // Test 2
            const authOk = await testAuth();
            
            // Test 3
            await testFirestoreConnection();
            
            // Test 4
            if (authOk) {
                await testReadUserData();
            }
            
            // Test 5
            testSecurityRules();
        }
        
        // Run tests on load
        window.onload = () => {
            runAllTests();
        };
    </script>
</body>
</html>