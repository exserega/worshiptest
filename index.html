<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agape Worship</title>
    <!-- Performance: preconnect/dns-prefetch for Firebase/Auth/CDN -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://securetoken.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://www.googleapis.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    <link rel="dns-prefetch" href="https://securetoken.googleapis.com">
    <link rel="stylesheet" href="styles.css?v=6.6">
    <link rel="stylesheet" href="styles/branch-selection-modal.css">
    <link rel="stylesheet" href="styles/events-overlay.css">
    <link rel="stylesheet" href="styles/event-modal.css">
    <link rel="stylesheet" href="src/modules/events/calendar.css">
    <link rel="stylesheet" href="styles/event-player.css">
    <link rel="stylesheet" href="src/modules/integration/integrationStyles.css">
    <link rel="stylesheet" href="src/modules/integration/calendarStyles.css">
    <link rel="stylesheet" href="src/modules/integration/eventActionStyles.css">
    <link rel="stylesheet" href="src/modules/integration/eventSelectorStyles.css">
    <link rel="stylesheet" href="styles/event-creation-fixes.css">
    <link rel="stylesheet" href="styles/event-creation-modal-complete.css">
    <link rel="stylesheet" href="styles/archive-save-modal.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Переопределение стилей кнопок - должно быть последним -->
    <link rel="stylesheet" href="styles/save-cancel-override.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">

      <link rel="manifest" href="/manifest.json">
  <script>
    // Performance metrics (basic) - non-blocking, reporting to console
    (function(){
      try {
        window.addEventListener('load', function(){
          var t = performance.timing;
          var ttfb = t.responseStart - t.requestStart;
          var domContentLoaded = t.domContentLoadedEventEnd - t.navigationStart;
          var loadTotal = t.loadEventEnd ? (t.loadEventEnd - t.navigationStart) : 0;
          console.log('[Perf] TTFB(ms):', ttfb, 'DCL(ms):', domContentLoaded, 'Load(ms):', loadTotal);
        });
      } catch(e) {}
    })();
  </script>
  <script>
    // Tablet CSS: load only for width between 768px and 1279px
    (function(){
      try {
        var mqTablet = window.matchMedia && window.matchMedia('(min-width: 768px) and (max-width: 1279px)');
        if (mqTablet && mqTablet.matches) {
          var l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = '/styles/tablet.css';
          document.head.appendChild(l);
        }
      } catch(e) {}
    })();
  </script>
  <script>
    // Desktop CSS: load only on width >= 1280px (do not download on mobile)
    (function(){
      try {
        var mq = window.matchMedia && window.matchMedia('(min-width: 1280px)');
        if (mq && mq.matches) {
          var l = document.createElement('link');
          l.rel = 'stylesheet';
          l.href = '/styles/desktop.css';
          document.head.appendChild(l);
        }
      } catch(e) {}
    })();
  </script>
  <script>
    // Применяем темную тему сразу, чтобы избежать мигания светлой темы
    (function() {
      var savedTheme = localStorage.getItem('theme');
      var theme = savedTheme || 'dark'; // По умолчанию - темная тема
      document.documentElement.setAttribute('data-theme-loading', theme);
      // Также устанавливаем тему на body сразу
      document.addEventListener('DOMContentLoaded', function() {
        document.body.setAttribute('data-theme', theme);
      });
    })();
  </script>
  <style>
    /* Критические стили для предотвращения мигания светлой темы */
    html[data-theme-loading="dark"] {
      background-color: #111827;
      color: #e5e7eb;
    }
    
    /* Критические стили для предотвращения мерцания UI элементов */
    /* Скрываем инструменты управления песней до выбора песни */
    body:not([data-song-loaded]) .control-group,
            body:not([data-song-loaded]) .song-legend-action,
        body:not([data-song-loaded]) .metronome-control-bar,
        body:not([data-song-loaded]) #edit-song-button,
        body:not([data-song-loaded]) #copy-text-button,
        body:not([data-song-loaded]) #holychords-button {
          display: none !important;
        }
    
    /* Показываем control-group как flex когда песня загружена */
    body[data-song-loaded] .control-group {
      display: flex !important;
    }

    /* loading-indicator оставляем компактным как раньше */
  </style>
</head>
<body>

<div id="notes-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3 class="modal-title">Заметка к песне</h3>
        <textarea id="note-edit-textarea" rows="6" placeholder="Введите текст заметки..."></textarea>
        <div class="modal-actions">
            <button id="save-note-button" class="modal-button primary">Сохранить</button>
            <button id="cancel-note-button" class="modal-button secondary">Отмена</button>
        </div>
        <button id="close-note-modal-x" class="icon-button-small">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- Модальное окно выбора филиала для новых пользователей -->
<div id="branch-selection-modal" class="modal-overlay">
    <div class="modal-content branch-selection-content">
        <h2 class="modal-title">Добро пожаловать в Agape Worship!</h2>
        <p class="modal-subtitle">Выберите филиал, к которому вы хотите присоединиться:</p>
        
        <div id="branches-list" class="branches-selection-grid">
            <!-- Филиалы будут загружены динамически -->
            <div class="loading-branches">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Загрузка филиалов...</span>
            </div>
        </div>
        
        <div class="modal-footer-info">
            <i class="fas fa-info-circle"></i>
            <span>После выбора филиала ваша заявка будет отправлена на рассмотрение администратору</span>
        </div>
    </div>
</div>

<header>
    <h1>Agape Worship</h1>
    <!-- Кнопка смены темы скрыта, функционал сохранен для будущей реализации -->
    <button id="theme-toggle-button" class="theme-toggle" title="Переключить тему" style="display: none;">
      <span class="theme-toggle-bg">
        <i class="fas fa-moon theme-icon moon"></i>
        <i class="fas fa-sun theme-icon sun"></i>
      </span>
      <span class="theme-toggle-slider">
        <i class="fas fa-moon"></i>
      </span>
    </button>
    
    <!-- Кнопка профиля -->
    <button id="profile-button" class="profile-button" title="Профиль пользователя">
      <i class="fas fa-user"></i>
    </button>
</header>

<main class="container">
    <section class="controls">
        <!-- Поиск с иконкой лупы -->
        <div class="search-group">
            <div class="search-input-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="search-input" placeholder="Поиск песен...">
                <button id="clear-main-search" class="clear-search-btn" style="display: none;" aria-label="Очистить поиск">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="search-results"></div>
        </div>
        
        <!-- Кнопка для открытия оверлея с песнями -->
        <div class="songs-button-container">
            <button id="open-songs-overlay" class="songs-overlay-button" title="Открыть список песен">
                <i class="fas fa-list"></i>
                <span>Все песни</span>
            </button>
        </div>
    </section>

    <!-- Элементы управления песней (скрыты по умолчанию) -->
    <div class="control-group">
        <fieldset class="key-group">
            <legend>Тональность</legend>
            <select id="key-select">
                <option value="C">C</option>
                <option value="C#">C#</option>
                <option value="Db">Db</option>
                <option value="D">D</option>
                <option value="D#">D#</option>
                <option value="Eb">Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F#</option>
                <option value="Gb">Gb</option>
                <option value="G">G</option>
                <option value="G#">G#</option>
                <option value="Ab">Ab</option>
                <option value="A">A</option>
                <option value="A#">A#</option>
                <option value="Bb">Bb</option>
                <option value="H">H</option>
                <option value="B">B</option>
            </select>
        </fieldset>
        <div class="function-buttons-group">
            <button id="toggle-chords-button" class="control-group-button icon-button simple" title="Скрыть аккорды">
                <i class="fas fa-guitar"></i>
                <span class="button-text">Аккорды</span>
            </button>
            <button id="chords-only-button" class="control-group-button icon-button simple" title="Показать только аккорды">
                <span class="text-icon">T</span>
                <span class="button-text">Только аккорды</span>
            </button>
            <button id="split-text-button" aria-label="Разделить текст" class="control-group-button icon-button simple">
                <i class="fas fa-columns"></i>
                <span class="button-text">Разделить</span>
            </button>
            <button id="copy-text-button" class="control-group-button icon-button simple" title="Копировать текст песни">
                <i class="far fa-copy"></i>
                <span class="button-text">Копировать</span>
            </button>
        </div>
        <div class="font-size-controls">
            <button id="zoom-out" class="icon-button simple" title="Уменьшить шрифт"><i class="fas fa-search-minus"></i></button>
            <button id="zoom-in" class="icon-button simple" title="Увеличить шрифт"><i class="fas fa-search-plus"></i></button>
        </div>
    </div>

    <fieldset id="song-content">
        <legend id="song-title">
            <span class="song-title-text">Выберите песню</span>
            <button id="edit-song-button" class="icon-button simple legend-button" title="Редактировать песню" style="display: none;">
                <i class="fas fa-edit"></i>
            </button>
        </legend>
        <div class="song-actions-legend-row">
            <div class="song-legend-action" data-legend="Сет лист">
                <button id="add-to-setlist-button" class="legend-icon-btn setlist" aria-label="Добавить в сет-лист" title="Добавить в сет-лист">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <!-- Убрано: кнопка "Мои" в легенде -->
            <div class="song-legend-action" data-legend="Репертуар">
                <button id="repertoire-button" class="legend-icon-btn mic" aria-label="Добавить в репертуар" title="Добавить в репертуар">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
        <pre id="song-display"></pre>
    </fieldset>

    <!-- Metronome Control Bar - Under Song -->
    <div class="metronome-control-bar">
        <button id="open-metronome-overlay" class="metronome-button" aria-label="Открыть метроном" title="Метроном">
            <i class="fas fa-drum" aria-hidden="true"></i>
            <span>Метроном</span>
        </button>
        
        <div class="current-bpm-display">
            <span id="current-bpm-value" class="bpm-value">NA</span>
            <span class="bpm-unit">BPM</span>
        </div>
        
        <button id="metronome-play-toggle" class="metronome-play-toggle" aria-label="Включить/выключить метроном" title="Play/Stop">
            <i class="fas fa-play"></i>
            <span class="play-text">Play</span>
        </button>
    </div>

    <!-- Overlay выбора сет-листа -->
    <div id="setlist-select-overlay" class="modal-overlay">
        <div class="modal-content setlist-select-modal compact">
            <div class="modal-header compact">
                <h3>Добавить в сет-лист</h3>
                <button id="close-setlist-select" class="icon-button-small" title="Закрыть">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body compact">
                <!-- Компактная информация о песне -->
                <div class="song-info-compact">
                    <i class="fas fa-music"></i>
                    <div class="song-details">
                        <span id="adding-song-name" class="song-name">Песня</span>
                        <span class="song-key">Тональность: <span id="adding-song-key">C</span></span>
                    </div>
                </div>
                
                <!-- Основной блок - существующие сет-листы -->
                <div class="existing-setlists-section">
                    <div class="section-title">Выберите сет-лист:</div>
                    <div id="setlists-grid" class="setlists-grid">
                        <!-- Сет-листы будут добавлены динамически -->
                    </div>
                </div>
                
                <!-- Создание нового - компактно внизу -->
                <div class="create-new-compact">
                    <span class="or-text">или создайте новый</span>
                    <div class="new-setlist-row">
                        <input type="text" 
                               id="new-setlist-name-modal" 
                               class="compact-input" 
                               placeholder="Название нового сет-листа">
                        <button id="create-and-add" class="compact-button" disabled>
                            <i class="fas fa-plus"></i>
                            Создать
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактора -->
    <div id="song-editor-overlay" class="song-editor-overlay">
        <div class="song-editor-modal">
            <div class="song-editor-header">
                <h3 id="song-editor-title">Редактирование песни</h3>
                <button id="close-editor-button" class="icon-button-small" title="Закрыть редактор">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="song-editor-content">
                <div class="editor-info">
                    <span id="edit-status-info">📄 Оригинал из Google Таблицы</span>
                    <button id="revert-to-original-button" class="editor-button revert" style="display: none;">
                        <i class="fas fa-undo"></i>
                        Вернуть оригинал
                    </button>
                </div>
                
                <textarea id="song-edit-textarea" class="song-edit-textarea" placeholder="Введите текст песни с аккордами..."></textarea>
            </div>
            
            <div class="song-editor-footer">
                <div class="editor-controls">
                    <div class="editor-row">
                        <button id="save-edit-button" class="editor-button save">
                            <i class="fas fa-save"></i>
                            Сохранить у себя
                        </button>
                        <button id="save-global-button" class="editor-button save" style="display:none;">
                            <i class="fas fa-globe"></i>
                            Сохранить у всех
                        </button>
                    </div>
                    <div class="editor-row secondary" id="editor-secondary-row">
                        <button id="delete-user-override-button" class="editor-button cancel" style="display:none;">
                            <i class="fas fa-user-slash"></i>
                            Удалить мою версию
                        </button>
                        <button id="delete-global-override-button" class="editor-button revert" style="display:none;">
                            <i class="fas fa-undo"></i>
                            Восстановить оригинал
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>



     <section id="youtube-player-section" style="margin-top: 20px; display: none;">
         <h3>Видео / Аудио</h3>
         <p id="youtube-video-key-display" style="text-align: center; margin-bottom: 10px; display: none; font-size: 0.9rem; color: var(--label-color);"></p>
         <div id="youtube-player-container" style="max-width: 100%; margin: auto;">
             </div>
     </section>

    <div class="controls-footer">
        <a id="holychords-button" href="#" target="_blank" style="display: none;">Holychords</a>
    </div>
</main>

<aside id="setlists-panel" class="side-panel setlists-panel">
    <button class="side-panel-close-btn icon-button simple" title="Закрыть панель">
        <i class="fas fa-chevron-left"></i>
    </button>
    
    <!-- Заголовок с кнопкой филиала -->
    <div class="panel-header-section">
        <div class="panel-header-row">
            <div class="panel-title-group">
                <h3 class="panel-title">Сет-листы</h3>
                <button id="setlist-branch-btn" class="icon-button-header branch-button" title="Сменить филиал">
                    <i class="fas fa-church"></i>
                    <span id="current-branch-name" class="branch-name">Загрузка...</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Кнопка создания сет-листа сверху -->
    <div class="panel-create-section">
        <button id="create-new-setlist-header-btn" class="icon-button-header primary create-setlist-button full-width" title="Создать новый сет-лист">
            <i class="fas fa-plus"></i>
            <span>Создать сет-лист</span>
        </button>
    </div>
    
    <!-- Селектор филиала (скрытый попап) -->
    <div id="branch-selector-popup" class="branch-selector-popup" style="display: none;">
        <select id="setlist-branch-selector" class="branch-selector">
            <option value="">Загрузка...</option>
        </select>
    </div>
    
    <!-- Контейнер для карточек сет-листов -->
    <div id="setlists-cards-container" class="setlists-cards-container">
        <div class="empty-message">Загрузка сет-листов...</div>
    </div>
    
    <!-- Скрытые элементы для совместимости -->
    <div style="display: none;">
        <button id="setlist-dropdown-btn"></button>
        <span id="current-setlist-name"></span>
        <div id="setlist-dropdown-menu">
            <div id="setlists-list-container"></div>
        </div>
        <div id="selected-setlist-control">
            <span id="songs-count-text"></span>
            <button id="add-song-btn"></button>
            <button id="start-presentation-button"></button>
            <button id="add-to-calendar-btn"></button>
            <button id="save-to-archive-btn"></button>
        </div>
    </div>
    
    <!-- Контейнер для песен активной карточки (для совместимости) -->
    <div id="current-setlist-songs-container" style="display: none;">
    </div>

</aside>

<aside id="my-list-panel" class="side-panel my-list-panel">
    <button class="side-panel-close-btn icon-button simple" title="Закрыть панель"><i class="fas fa-chevron-left"></i></button>
    <div id="my-list" class="list-section">
        <h3>Мои</h3>
        <div id="favorites-list" class="list-container">
            <div class="empty-message">Загрузка...</div>
        </div>
    </div>
</aside>

<aside id="repertoire-panel" class="side-panel repertoire-panel">
    <button class="side-panel-close-btn icon-button simple" title="Закрыть панель"><i class="fas fa-chevron-right"></i></button>
    <h3 class="panel-header">Репертуар</h3>

    <div class="repertoire-vocalist-selector">
        <label for="vocalist-select">Вокалист:</label>
        <select id="vocalist-select">
            <option value="">-- Выберите вокалиста --</option>
            </select>
    </div>

    <div class="repertoire-view-controls">
        <button id="repertoire-view-key" class="repertoire-view-button active" title="Группировать по тональности">
            <i class="fas fa-key"></i> <span class="button-text-rp">По тональности</span>
        </button>
        <button id="repertoire-view-sheet" class="repertoire-view-button" title="Группировать по листам">
            <i class="far fa-file-alt"></i> <span class="button-text-rp">По листам</span>
        </button>
        <button id="repertoire-view-all" class="repertoire-view-button" title="Показать весь список алфавитном порядке">
            <i class="fas fa-sort-alpha-down"></i> <span class="button-text-rp">Весь список</span>
        </button>
    </div>
    <div id="repertoire-panel-list" class="repertoire-list-container list-container">
        <div class="empty-message">Выберите вокалиста для просмотра репертуара.</div>
        </div>
</aside>

<div id="presentation-overlay" class="presentation-overlay">
    <button id="presentation-close-btn" class="presentation-close-btn" title="Закрыть режим презентации">&times;</button>
    <button id="pres-split-text-btn" class="presentation-control-btn" title="Разделить текст">
        <i class="fas fa-columns"></i>
    </button>
    <div class="presentation-controls">
        <button id="pres-prev-btn" class="presentation-nav-btn" title="Предыдущая песня">
            <i class="fas fa-chevron-left"></i>
        </button>
        <span id="pres-counter" class="presentation-counter">0 / 0</span>
        <button id="pres-next-btn" class="presentation-nav-btn" title="Следующая песня">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
    <div id="presentation-content" class="presentation-content">
        </div>
</div>

<!-- Metronome Overlay -->
<div id="metronome-overlay" class="metronome-overlay">
    <div class="metronome-modal">
        <div class="metronome-header">
            <div class="metronome-time-signature">
                <select id="metronome-time-signature" class="time-signature-select">
                    <option value="4">4/4</option>
                    <option value="3">3/4</option>
                    <option value="6">6/8</option>
                    <option value="2">2/4</option>
                </select>
            </div>
            
            <div class="metronome-bpm-display">
                <input type="number" id="metronome-bpm-input" class="bpm-input-large" min="40" max="200" step="1" value="120">
                <span class="bpm-label">BPM</span>
            </div>
            
            <button id="close-metronome-overlay" class="icon-button metronome-close" title="Закрыть метроном">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Дополнительные настройки метронома -->
        <div class="metronome-settings">
            <label class="metronome-accent-toggle" for="metronome-accent-enabled">
                <input type="checkbox" id="metronome-accent-enabled" checked>
                <span class="toggle-slider"></span>
                <span class="toggle-label">Акцент на первой доле</span>
            </label>
        </div>
        
        <div class="metronome-main-controls">
            <div class="bmp-controls-row">
                <button class="bpm-control-btn bpm-decrease" id="metronome-bpm-decrease" title="Уменьшить BPM">
                    <i class="fas fa-minus"></i>
                </button>
                
                <div class="bpm-slider-container">
                    <div class="bpm-slider-track">
                        <div class="bpm-slider-progress" id="bpm-slider-progress"></div>
                        <div class="bpm-slider-handle" id="bpm-slider-handle">
                            <div class="handle-indicator"></div>
                        </div>
                    </div>
                    <div class="bpm-range-labels">
                        <span class="range-min">40</span>
                        <span class="range-max">200</span>
                    </div>
                </div>
                
                <button class="bpm-control-btn bpm-increase" id="metronome-bpm-increase" title="Увеличить BPM">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="metronome-play-controls">
                <button id="metronome-play-button" class="metronome-play-button-large" aria-label="Включить метроном">
                    <i class="fas fa-play"></i>
                </button>
            </div>
            
            <!-- Визуальный индикатор метронома -->
            <div class="metronome-visual-indicator" id="metronome-visual-indicator">
                <div class="beat-dots-container" id="beat-dots-container">
                    <!-- Точки будут добавлены динамически через JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<div id="loading-indicator">Загрузка...</div>

<nav class="mobile-bottom-nav" role="navigation" aria-label="Основная навигация">
    <button id="toggle-setlists" class="mobile-nav-button" aria-label="Открыть панель сет-листов" title="Сет-листы">
        <i class="fas fa-music" aria-hidden="true"></i>
        <span>Сет-листы</span>
    </button>
    <button id="toggle-events" class="mobile-nav-button" aria-label="Открыть события филиала" title="События">
        <i class="fas fa-calendar-alt" aria-hidden="true"></i>
        <span>События</span>
    </button>
    <button id="toggle-repertoire" class="mobile-nav-button" aria-label="Открыть репертуар вокалистов" title="Репертуар">
        <i class="fas fa-microphone" aria-hidden="true"></i>
        <span>Репертуар</span>
    </button>
    <button id="toggle-archive" class="mobile-nav-button" aria-label="Открыть архив сет-листов" title="Архив">
        <i class="fas fa-archive" aria-hidden="true"></i>
        <span>Архив</span>
    </button>
</nav>

 

  <!-- New Metronome Module - No external libraries needed -->
  
  <script type="module" src="script.js"></script>
  
  <!-- Модульная система фаззи-поиска -->
  <script type="module">
    // Импортируем поисковый движок
    import searchEngine from './src/js/search/searchEngine.js';
    
    // Делаем поисковый движок доступным глобально
    window.searchEngine = searchEngine;
    
    // Интегрируем с существующей системой
    document.addEventListener('DOMContentLoaded', () => {
        // Ждем загрузки данных и инициализируем словарь
        const initSearchEngine = () => {
            if (window.state && window.state.allSongs && window.state.allSongs.length > 0) {
                searchEngine.initializeDictionary(window.state.allSongs);
                console.log('🔍 Фаззи-поиск инициализирован');
            } else {
                // Повторяем через 500ms если данные еще не загружены
                setTimeout(initSearchEngine, 500);
            }
        };
        
        initSearchEngine();
    });
  </script>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then(registration => {
              console.log('Service Worker зарегистрирован:', registration);
              
              // Получаем и логируем версию Service Worker
              if (registration.active) {
                registration.active.postMessage({ type: 'GET_VERSION' });
              }
              
              // Слушаем ответ от Service Worker с версией
              navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'VERSION') {
                  console.log(`📦 Service Worker версия: ${event.data.version}`);
                }
              });
            })
            .catch(error => {
              console.log('Ошибка регистрации Service Worker:', error);
            });
        });
      }
    </script>
<!-- === ГЛОБАЛЬНЫЕ ОВЕРЛЕИ (ПОВЕРХ ВСЕГО) === -->

<!-- Модальное окно для создания нового сет-листа -->
<div id="create-setlist-modal" class="global-overlay">
    <div class="overlay-content create-setlist-content">
        <div class="overlay-header">
            <h3 style="margin: 0; color: var(--text-primary);">Введите название сет-листа</h3>
            <button id="close-create-modal" class="icon-button-small">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="overlay-body" style="padding-top: 8px;">
            <div class="input-section">
                <input 
                    type="text" 
                    id="new-setlist-name-input" 
                    class="modern-input"
                    placeholder="Название..."
                    maxlength="50"
                >
            </div>
        </div>
        <div class="overlay-footer">
            <button id="cancel-create-setlist" class="btn-modern secondary">
                <i class="fas fa-times"></i>
                <span>Отмена</span>
            </button>
            <button id="create-setlist-button" class="btn-modern primary">
                <i class="fas fa-arrow-right"></i>
                <span>Сохранить</span>
            </button>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения добавления песен удалено по требованию: сразу открываем overlay добавления -->

<!-- Полноэкранный оверлей для добавления песен -->
<div id="add-songs-overlay" class="global-fullscreen-overlay">
    <div class="fullscreen-content">
        <div class="fullscreen-header">
            <div class="header-top-row">
                <div class="header-left">
                    <button id="close-add-songs" class="icon-button-small">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="header-title">
                        <h3>Добавить песни</h3>
                    </div>
                </div>
                <div class="header-right">
                    <div class="added-counter">
                        <i class="fas fa-music"></i>
                        <span id="added-songs-count">0</span>
                    </div>
                    <button id="finish-adding-songs" class="btn-modern primary">
                        <i class="fas fa-check"></i>
                        <span>Готово</span>
                    </button>
                </div>
            </div>
            <div class="header-subtitle">
                <span>в сет-лист "</span><span id="target-setlist-name" class="setlist-name"></span><span>"</span>
            </div>
        </div>
        
        <div class="fullscreen-body">
            <div class="search-section">
                <div class="search-container">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input 
                            type="text" 
                            id="song-search-input" 
                            class="search-input"
                            placeholder="Поиск песен по названию..."
                        >
                        <button id="clear-search" class="clear-search-btn" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                        
                        <!-- Dropdown для результатов поиска в overlay -->
                        <div id="overlay-search-results" class="overlay-search-dropdown" style="display: none;">
                            <div class="search-results-container">
                                <!-- Результаты поиска будут добавлены динамически -->
                            </div>
                        </div>
                    </div>
                    <div class="search-filters">
                        <select id="category-filter" class="filter-select">
                            <option value="">Все категории</option>
                        </select>
                        <button id="show-added-only" class="filter-btn">
                            <span>Добавленные</span>
                            <span id="added-songs-count-badge" class="added-count-badge" style="display: none;">0</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <div id="songs-grid" class="songs-grid">
                    <div class="loading-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Загрузка песен...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Полноэкранный preview с выбором тональности -->
<div id="key-selection-modal" class="global-fullscreen-overlay">
    <div class="fullscreen-content song-preview-content">
        <!-- Профессиональная шапка -->
        <div class="song-preview-header">
            <!-- Строка с заголовком и закрытием -->
            <div class="header-top">
                <button id="close-key-modal" class="icon-button-small">
                    <i class="fas fa-times"></i>
                </button>
                <div class="header-title">
                    <h3 id="key-song-name">Выберите тональность для песни "Название песни"</h3>
                </div>
            </div>
            
            <!-- Строка с контролами и действием -->
            <div class="header-controls">
                <div class="tonality-controls-wrapper">
                    <span class="tonality-label">Тональность:</span>
                    <select id="key-selector" class="key-select-modern">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="Db">Db</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="Eb">Eb</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="Gb">Gb</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="Ab">Ab</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="Bb">Bb</option>
                        <option value="H">H</option>
                        <option value="B">B</option>
                    </select>
                    <span id="original-key-badge" class="key-badge-subtle">оригинал: C</span>
                </div>
                <button id="confirm-key-selection" class="btn-action-secondary">
                    <i class="fas fa-check"></i>
                    <span>Готово</span>
                </button>
            </div>
        </div>

        <!-- Текст песни с аккордами -->
        <div class="song-text-container">
            <div id="song-text-display" class="song-text-display">
                <div class="loading-text">
                    <i class="fas fa-music"></i>
                    <p>Загрузка текста песни...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Мобильный overlay для просмотра песни при добавлении -->
<div id="mobile-song-preview-overlay" class="global-fullscreen-overlay">
    <div class="fullscreen-content">
        <div class="fullscreen-header">
            <div class="header-top-row">
                <div class="header-left">
                    <button id="close-mobile-song-preview" class="icon-button-small">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="header-title">
                        <h3 id="mobile-song-title">Название песни</h3>
                    </div>
                </div>
                <div class="header-right">
                    <button id="add-song-to-setlist-mobile" class="btn-modern primary">
                        <i class="fas fa-plus"></i>
                        <span>Добавить</span>
                    </button>
                </div>
            </div>
            <div class="header-subtitle">
                <span>Тональность: </span>
                <select id="mobile-key-selector" class="key-selector-mobile">
                    <option value="C">C</option>
                    <option value="C#">C#</option>
                    <option value="Db">Db</option>
                    <option value="D">D</option>
                    <option value="D#">D#</option>
                    <option value="Eb">Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F#</option>
                    <option value="Gb">Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G#</option>
                    <option value="Ab">Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A#</option>
                    <option value="Bb">Bb</option>
                    <option value="H">H</option>
                    <option value="B">B</option>
                </select>
            </div>
        </div>
        
        <div class="fullscreen-body">
            <div class="mobile-song-content">
                <div id="mobile-song-text" class="song-text-display">
                    <!-- Здесь будет отображаться текст песни с аккордами -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK (compat version) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<!-- Firebase Initialization -->
<script type="module" src="./firebase-init.js"></script>
<script type="module">
    import { auth } from './firebase-init.js';
    
    // Устанавливаем persistence для сохранения сессии между страницами
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
            console.log('✅ Firebase persistence set to LOCAL');
        })
        .catch((error) => {
            console.error('Error setting persistence:', error);
        });
</script>

<!-- Overrides API bridge for legacy scripts -->
<script>
    window.apiOverrides = {};
  </script>
<script type="module">
    import * as overrides from '/src/api/overrides.js';
    window.apiOverrides = overrides;
  </script>

<!-- Development Testing Scripts -->
<!-- Удалено для продакшена: <script src="tests/baseline-test.js"></script> -->

</body>
</html>
