<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: #2a2a2a;
            border-radius: 10px;
            max-width: 600px;
        }
        .button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .button:hover {
            background: #45a049;
        }
        .button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .stats {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        .progress {
            background: #333;
            height: 20px;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #4CAF50;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        .log {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <div class="container">
        <h1>üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
        <p>–≠—Ç–∞ —É—Ç–∏–ª–∏—Ç–∞ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</p>
        <ul style="text-align: left;">
            <li><strong>pending</strong> ‚Üí <strong>active</strong></li>
            <li><strong>banned</strong> ‚Üí <strong>blocked</strong></li>
        </ul>
        
        <div id="stats" class="stats" style="display: none;">
            <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
            <div id="stats-content"></div>
        </div>
        
        <div class="progress" id="progress" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div id="log" class="log" style="display: none;"></div>
        
        <button class="button" id="check-btn" onclick="checkStatuses()">
            üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã
        </button>
        
        <button class="button" id="migrate-btn" onclick="migrateStatuses()" disabled>
            üöÄ –ù–∞—á–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
        </button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlkjVQFtFpMRFexAi6nBqEkIfjFlU5cDo",
            authDomain: "song-archive-389a6.firebaseapp.com",
            projectId: "song-archive-389a6",
            storageBucket: "song-archive-389a6.appspot.com",
            messagingSenderId: "660585697058",
            appId: "1:660585697058:web:7ceacf752ce6b21ad8fb40",
            measurementId: "G-Z6QYH5YD2E"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let usersToMigrate = [];
        
        function log(message, isError = false) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString('ru-RU');
            logEl.innerHTML += `<div style="color: ${isError ? '#f44336' : '#4CAF50'}">[${time}] ${message}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        async function checkStatuses() {
            try {
                document.getElementById('check-btn').disabled = true;
                document.getElementById('stats').style.display = 'block';
                document.getElementById('log').style.display = 'block';
                
                log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                
                const snapshot = await db.collection('users').get();
                
                const stats = {
                    total: 0,
                    active: 0,
                    pending: 0,
                    banned: 0,
                    blocked: 0,
                    other: 0
                };
                
                usersToMigrate = [];
                
                snapshot.forEach(doc => {
                    const user = doc.data();
                    stats.total++;
                    
                    switch(user.status) {
                        case 'active':
                            stats.active++;
                            break;
                        case 'pending':
                            stats.pending++;
                            usersToMigrate.push({id: doc.id, email: user.email, oldStatus: 'pending', newStatus: 'active'});
                            break;
                        case 'banned':
                            stats.banned++;
                            usersToMigrate.push({id: doc.id, email: user.email, oldStatus: 'banned', newStatus: 'blocked'});
                            break;
                        case 'blocked':
                            stats.blocked++;
                            break;
                        default:
                            stats.other++;
                    }
                });
                
                const statsHtml = `
                    <p>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: <strong>${stats.total}</strong></p>
                    <p>–ê–∫—Ç–∏–≤–Ω—ã—Ö (active): <strong>${stats.active}</strong></p>
                    <p style="color: #ff9800;">–û–∂–∏–¥–∞—é—Ç (pending): <strong>${stats.pending}</strong> ‚Üí –±—É–¥—É—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã</p>
                    <p style="color: #ff9800;">–ó–∞–±–∞–Ω–µ–Ω—ã (banned): <strong>${stats.banned}</strong> ‚Üí –±—É–¥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</p>
                    <p>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (blocked): <strong>${stats.blocked}</strong></p>
                    ${stats.other > 0 ? `<p>–î—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—É—Å—ã: <strong>${stats.other}</strong></p>` : ''}
                    <hr>
                    <p><strong>–¢—Ä–µ–±—É—é—Ç –º–∏–≥—Ä–∞—Ü–∏–∏: ${usersToMigrate.length}</strong></p>
                `;
                
                document.getElementById('stats-content').innerHTML = statsHtml;
                
                if (usersToMigrate.length > 0) {
                    document.getElementById('migrate-btn').disabled = false;
                    log(`–ù–∞–π–¥–µ–Ω–æ ${usersToMigrate.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏`);
                } else {
                    log('–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã');
                }
                
            } catch (error) {
                log(`–û—à–∏–±–∫–∞: ${error.message}`, true);
            } finally {
                document.getElementById('check-btn').disabled = false;
            }
        }
        
        async function migrateStatuses() {
            if (usersToMigrate.length === 0) {
                log('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏', true);
                return;
            }
            
            const confirmMsg = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å ${usersToMigrate.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?\n\n` +
                              `pending ‚Üí active: ${usersToMigrate.filter(u => u.oldStatus === 'pending').length}\n` +
                              `banned ‚Üí blocked: ${usersToMigrate.filter(u => u.oldStatus === 'banned').length}`;
            
            if (!confirm(confirmMsg)) return;
            
            document.getElementById('migrate-btn').disabled = true;
            document.getElementById('check-btn').disabled = true;
            document.getElementById('progress').style.display = 'block';
            
            log(`–ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ ${usersToMigrate.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...`);
            
            let completed = 0;
            let errors = 0;
            
            for (const user of usersToMigrate) {
                try {
                    await db.collection('users').doc(user.id).update({
                        status: user.newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    completed++;
                    log(`‚úÖ ${user.email}: ${user.oldStatus} ‚Üí ${user.newStatus}`);
                    
                } catch (error) {
                    errors++;
                    log(`‚ùå ${user.email}: ${error.message}`, true);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                const progress = ((completed + errors) / usersToMigrate.length) * 100;
                document.getElementById('progress-bar').style.width = `${progress}%`;
            }
            
            log(`\n–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!`);
            log(`–£—Å–ø–µ—à–Ω–æ: ${completed}, –û—à–∏–±–æ–∫: ${errors}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            setTimeout(() => checkStatuses(), 1000);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä');
                window.location.href = '/login.html';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (!userDoc.exists || userDoc.data().role !== 'admin') {
                alert('–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º');
                window.location.href = '/';
                return;
            }
            
            log('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞.');
        });
    </script>
</body>
</html>