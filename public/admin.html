<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <!-- Performance: preconnect/dns-prefetch for Firebase/Auth/CDN -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://securetoken.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://www.googleapis.com">
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    <link rel="dns-prefetch" href="https://securetoken.googleapis.com">
    <script>
      (function(){
        try {
          window.addEventListener('load', function(){
            var t = performance.timing;
            var ttfb = t.responseStart - t.requestStart;
            var dcl = t.domContentLoadedEventEnd - t.navigationStart;
            console.log('[Perf][Admin] TTFB:', ttfb, 'DCL:', dcl);
          });
        } catch(e) {}
      })();
    </script>
    <link rel="stylesheet" href="../css/admin.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK 8.10.0 - –∫–∞–∫ –≤ settings.html -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö -->
    <div id="error-container" style="display: none;">
        <div class="error-message">
            <h1>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
            <p id="error-text">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</p>
            <a href="/login.html" class="button">–í–æ–π—Ç–∏</a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ -->
    <div id="admin-container" style="display: none;">
        <header class="admin-header">
            <button class="icon-button" onclick="history.back()" aria-label="–ù–∞–∑–∞–¥">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <div class="header-info">
                <span id="admin-name"></span>
                <span id="admin-role" class="badge"></span>
            </div>
        </header>

        <!-- –¢–∞–±—ã -->
        <nav class="admin-tabs">
            <button class="tab-button active" data-tab="users">
                <i class="fas fa-users"></i>
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            </button>
            <button class="tab-button" data-tab="requests">
                <i class="fas fa-user-clock"></i>
                <span>–ó–∞—è–≤–∫–∏</span>
                <span id="requests-count" class="badge"></span>
            </button>
            <button class="tab-button" data-tab="branch-requests">
                <i class="fas fa-code-branch"></i>
                <span>–ó–∞—è–≤–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤</span>
                <span id="branch-requests-count" class="badge"></span>
            </button>
            <button class="tab-button" data-tab="branches">
                <i class="fas fa-building"></i>
                <span>–§–∏–ª–∏–∞–ª—ã</span>
            </button>
        </nav>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ -->
        <main class="admin-content">
            <!-- –¢–∞–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <section id="users-tab" class="tab-content active">
                <div class="controls-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                    </div>
                    <div class="filters">
                        <select id="role-filter">
                            <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                            <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</option>
                            <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                        </select>
                        <select id="status-filter">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="pending">–û–∂–∏–¥–∞—é—â–∏–µ</option>
                            <option value="banned">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                        </select>
                        <select id="branch-filter">
                            <option value="">–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</option>
                        </select>
                    </div>
                    <button class="button" onclick="exportUsers()">
                        <i class="fas fa-download"></i>
                        –≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>
                <div id="users-list" class="users-grid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
                </div>
            </section>

            <!-- –¢–∞–± –∑–∞—è–≤–æ–∫ -->
            <section id="requests-tab" class="tab-content">
                <div class="controls-bar">
                    <h2>–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h2>
                    <div class="filters">
                        <select id="requests-filter-branch">
                            <option value="">–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</option>
                        </select>
                    </div>
                </div>
                <div id="requests-list" class="requests-grid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
                </div>
            </section>

            <!-- –¢–∞–± –∑–∞—è–≤–æ–∫ –Ω–∞ —Ñ–∏–ª–∏–∞–ª—ã -->
            <section id="branch-requests-tab" class="tab-content">
                <div class="controls-bar">
                    <h2>–ó–∞—è–≤–∫–∏ –Ω–∞ —Ñ–∏–ª–∏–∞–ª—ã</h2>
                    <div class="info-text">
                        <i class="fas fa-info-circle"></i>
                        –ó–∞—è–≤–∫–∏ –Ω–∞ —Å–º–µ–Ω—É –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞ –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —Ñ–∏–ª–∏–∞–ª–∞–º
                    </div>
                </div>
                <div id="branch-requests-list" class="branch-requests-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
                </div>
            </section>

            <!-- –¢–∞–± —Ñ–∏–ª–∏–∞–ª–æ–≤ -->
            <section id="branches-tab" class="tab-content">
                <div class="controls-bar" id="branches-controls">
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ -->
                </div>
                <div id="branches-list" class="branches-grid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="notifications-container"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="modals-container"></div>

    <!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- –ï–¥–∏–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (v8) –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ -->
    <script type="module" src="../firebase-init.js"></script>

    <script type="module">
        import logger from '../src/utils/logger.js';
        window.appLogger = logger;
    </script>

    <script>
        // ====================================
        // FIREBASE INITIALIZATION
        // ====================================
        
        // Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ ../firebase-init.js
        let auth, db;
        document.addEventListener('DOMContentLoaded', () => {
            try {
                auth = firebase.auth();
                db = firebase.firestore();

                // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                    .then(() => (window.appLogger ? window.appLogger.log('‚úÖ Firebase persistence set to LOCAL (admin)') : console.log('‚úÖ Firebase persistence set to LOCAL (admin)')))
                    .catch((error) => (window.appLogger ? window.appLogger.error('Error setting persistence (admin):', error) : console.error('Error setting persistence (admin):', error)));
            } catch (e) {
                if (window.appLogger) window.appLogger.error('Firebase not initialized yet:', e);
                else console.error('Firebase not initialized yet:', e);
            }
        });

        // ====================================
        // GLOBAL STATE
        // ====================================
        
        let currentUser = null;
        let currentTab = 'users';
        let branches = [];
        let users = [];
        let transfers = [];
        let isRootAdmin = false;

        // ====================================
        // AUTH CHECK AND INITIALIZATION
        // ====================================
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - –∫–∞–∫ –≤ settings.js
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.appLogger) window.appLogger.log('üî• Admin page loading...'); else console.log('üî• Admin page loading...');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            auth.onAuthStateChanged(async (user) => {
                if (window.appLogger) window.appLogger.log('üîê Auth state changed:', user ? user.email : 'No user'); else console.log('üîê Auth state changed:', user ? user.email : 'No user');
                
                if (!user) {
                    if (window.appLogger) window.appLogger.warn('‚ùå Not authenticated, showing error'); else console.log('‚ùå Not authenticated, showing error');
                    showError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                    return;
                }
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                    if (window.appLogger) window.appLogger.warn('‚ùå User profile not found'); else console.log('‚ùå User profile not found');
                        showError('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    currentUser = { id: user.uid, ...userData };
                    
                    if (window.appLogger) window.appLogger.log('‚úÖ User profile loaded:', currentUser); else console.log('‚úÖ User profile loaded:', currentUser);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    if (userData.role !== 'admin') {
                        if (window.appLogger) window.appLogger.warn('‚ùå User is not admin:', userData.role); else console.log('‚ùå User is not admin:', userData.role);
                        showError('–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–º
                    isRootAdmin = userData.isFounder || userData.isRootAdmin || false;
                    if (window.appLogger) window.appLogger.log('‚úÖ Admin access granted, isRootAdmin:', isRootAdmin); else console.log('‚úÖ Admin access granted, isRootAdmin:', isRootAdmin);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                    document.getElementById('error-container').style.display = 'none';
                    document.getElementById('admin-container').style.display = 'block';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    updateAdminInfo(user, isRootAdmin);
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                    initAdminPanel(currentUser, isRootAdmin);
                    
                } catch (error) {
                    console.error('‚ùå Error loading admin panel:', error);
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
                }
            });
        });

        // ====================================
        // UI FUNCTIONS
        // ====================================
        
        function showError(message) {
            document.getElementById('error-container').style.display = 'flex';
            document.getElementById('admin-container').style.display = 'none';
            document.getElementById('error-text').textContent = message;
        }
        
        function updateAdminInfo(user, isRootAdmin) {
            document.getElementById('admin-name').textContent = user.displayName || user.email;
            const roleEl = document.getElementById('admin-role');
            roleEl.textContent = isRootAdmin ? '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            roleEl.className = 'badge ' + (isRootAdmin ? 'badge-danger' : 'badge-warning');
        }

        // ====================================
        // ADMIN PANEL INITIALIZATION
        // ====================================
        
        async function initAdminPanel(user, isRootAdmin) {
            if (window.appLogger) window.appLogger.log('üöÄ Initializing admin panel...'); else console.log('üöÄ Initializing admin panel...');
            
            try {
                // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
                const { initAdminPanel: initAdminCore } = await import('../src/modules/admin/adminCore.js');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                await import('../src/modules/admin/notifications.js');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Å –º–æ–¥—É–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
                await initAdminCore(user, isRootAdmin);
                
                if (window.appLogger) window.appLogger.log('‚úÖ Admin panel modules loaded successfully'); else console.log('‚úÖ Admin panel modules loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading admin modules:', error);
                
                // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –µ—Å–ª–∏ –º–æ–¥—É–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                if (window.appLogger) window.appLogger.warn('‚ö†Ô∏è Falling back to inline initialization...'); else console.log('‚ö†Ô∏è Falling back to inline initialization...');
                await                     initAdminPanelFallback(user, isRootAdmin);
            }
        }
        
        // –†–µ–∑–µ—Ä–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
        async function initAdminPanelFallback(user, isRootAdmin) {
            if (window.appLogger) window.appLogger.log('üöÄ Initializing admin panel (fallback)...'); else console.log('üöÄ Initializing admin panel (fallback)...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            await Promise.all([
                loadBranches(),
                loadUsers(),
                loadTransfers()
            ]);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventHandlers();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞–±
            showTab('users');
        }
        
        // ====================================
        // DATA LOADING
        // ====================================
        
        async function loadBranches() {
            try {
                const snapshot = await db.collection('branches').get();
                branches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.appLogger) window.appLogger.log('‚úÖ Loaded branches:', branches.length); else console.log('‚úÖ Loaded branches:', branches.length);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤
                updateBranchFilter();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã
                displayBranches();
            } catch (error) {
                console.error('Error loading branches:', error);
            }
        }
        
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.appLogger) window.appLogger.log('‚úÖ Loaded users:', users.length); else console.log('‚úÖ Loaded users:', users.length);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function loadTransfers() {
            try {
                const snapshot = await db.collection('transferRequests')
                    .where('status', '==', 'pending')
                    .get();
                transfers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (window.appLogger) window.appLogger.log('‚úÖ Loaded transfers:', transfers.length); else console.log('‚úÖ Loaded transfers:', transfers.length);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏
                displayTransfers();
            } catch (error) {
                console.error('Error loading transfers:', error);
            }
        }
        
        // ====================================
        // UI DISPLAY FUNCTIONS
        // ====================================
        
        function displayUsers() {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            let filteredUsers = [...users];
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏
            const roleFilter = document.getElementById('role-filter').value;
            if (roleFilter) {
                filteredUsers = filteredUsers.filter(u => u.role === roleFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filteredUsers = filteredUsers.filter(u => u.status === statusFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–∏–ª–∏–∞–ª—É
            const branchFilter = document.getElementById('branch-filter').value;
            if (branchFilter) {
                filteredUsers = filteredUsers.filter(u => u.branchId === branchFilter);
            }
            
            // –ü–æ–∏—Å–∫
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u => 
                    (u.name && u.name.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.phone && u.phone.includes(searchTerm))
                );
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            container.innerHTML = filteredUsers.map(user => `
                <div class="user-card">
                    <div class="user-header">
                        <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="${user.name}" class="user-avatar">
                        <div class="user-info">
                            <h3>${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</h3>
                            <p>${user.email || user.phone || '–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤'}</p>
                        </div>
                    </div>
                    <div class="user-badges">
                        <span class="badge badge-${getRoleBadgeClass(user.role)}">${getRoleText(user.role)}</span>
                        <span class="badge badge-${getStatusBadgeClass(user.status)}">${getStatusText(user.status)}</span>
                        ${user.branchId ? `<span class="badge">${getBranchName(user.branchId)}</span>` : ''}
                    </div>
                    <div class="user-actions">
                        <button class="button small" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${isRootAdmin && user.id !== currentUser.id ? `
                            <button class="button small danger" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function displayBranches() {
            const container = document.getElementById('branches-list');
            
            if (branches.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Ñ–∏–ª–∏–∞–ª–æ–≤</div>';
                return;
            }
            
            container.innerHTML = branches.map(branch => `
                <div class="branch-card">
                    <h3>${branch.name}</h3>
                    <p>${branch.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <div class="branch-stats">
                        <span><i class="fas fa-users"></i> ${getUsersInBranch(branch.id)} —á–µ–ª–æ–≤–µ–∫</span>
                    </div>
                    <div class="branch-actions">
                        <button class="button small" onclick="editBranch('${branch.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${isRootAdmin ? `
                            <button class="button small danger" onclick="deleteBranch('${branch.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function displayTransfers() {
            const container = document.getElementById('transfers-list');
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥</div>';
                return;
            }
            
            container.innerHTML = transfers.map(transfer => `
                <div class="transfer-card">
                    <div class="transfer-info">
                        <h4>${getUserName(transfer.userId)}</h4>
                        <p>–ò–∑: ${getBranchName(transfer.fromBranchId)} ‚Üí –í: ${getBranchName(transfer.toBranchId)}</p>
                        <p class="transfer-reason">${transfer.reason}</p>
                        <small>–ü–æ–¥–∞–Ω–∞: ${formatDate(transfer.createdAt)}</small>
                    </div>
                    <div class="transfer-actions">
                        <button class="button small success" onclick="approveTransfer('${transfer.id}')">
                            <i class="fas fa-check"></i> –û–¥–æ–±—Ä–∏—Ç—å
                        </button>
                        <button class="button small danger" onclick="rejectTransfer('${transfer.id}')">
                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ====================================
        // EVENT HANDLERS
        // ====================================
        
        function setupEventHandlers() {
            // –¢–∞–±—ã
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    showTab(tab);
                });
            });
            
            // –§–∏–ª—å—Ç—Ä—ã
            document.getElementById('role-filter').addEventListener('change', displayUsers);
            document.getElementById('status-filter').addEventListener('change', displayUsers);
            document.getElementById('branch-filter').addEventListener('change', displayUsers);
            document.getElementById('user-search').addEventListener('input', displayUsers);
        }
        
        function showTab(tabName) {
            currentTab = tabName;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}-tab`);
            });
        }
        
        // ====================================
        // HELPER FUNCTIONS
        // ====================================
        
        function getRoleBadgeClass(role) {
            const classes = {
                admin: 'danger',
                moderator: 'warning',
                user: 'info'
            };
            return classes[role] || 'secondary';
        }
        
        function getRoleText(role) {
            const texts = {
                admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                moderator: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
                user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
            };
            return texts[role] || role;
        }
        
        function getStatusBadgeClass(status) {
            const classes = {
                active: 'success',
                pending: 'warning',
                banned: 'danger'
            };
            return classes[status] || 'secondary';
        }
        
        function getStatusText(status) {
            const texts = {
                active: '–ê–∫—Ç–∏–≤–µ–Ω',
                pending: '–û–∂–∏–¥–∞–µ—Ç',
                banned: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
            };
            return texts[status] || status;
        }
        
        function getBranchName(branchId) {
            const branch = branches.find(b => b.id === branchId);
            return branch ? branch.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª';
        }
        
        function getUserName(userId) {
            const user = users.find(u => u.id === userId);
            return user ? user.name || user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        
        function getUsersInBranch(branchId) {
            return users.filter(u => u.branchId === branchId).length;
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ru-RU');
        }
        
        function updateBranchFilter() {
            const select = document.getElementById('branch-filter');
            select.innerHTML = '<option value="">–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</option>' +
                branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }
        
        // ====================================
        // ACTION FUNCTIONS (–∑–∞–≥–ª—É—à–∫–∏)
        // ====================================
        
        function editUser(userId) {
            if (window.appLogger) window.appLogger.info('Edit user:', userId); else console.log('Edit user:', userId);
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function deleteUser(userId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                if (window.appLogger) window.appLogger.warn('Delete user:', userId); else console.log('Delete user:', userId);
                alert('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            }
        }
        
        function editBranch(branchId) {
            if (window.appLogger) window.appLogger.info('Edit branch:', branchId); else console.log('Edit branch:', branchId);
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function deleteBranch(branchId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª–∏–∞–ª?')) {
                if (window.appLogger) window.appLogger.warn('Delete branch:', branchId); else console.log('Delete branch:', branchId);
                alert('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            }
        }
        
        function showCreateBranchModal() {
            alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function approveTransfer(transferId) {
            if (window.appLogger) window.appLogger.info('Approve transfer:', transferId); else console.log('Approve transfer:', transferId);
            alert('–§—É–Ω–∫—Ü–∏—è –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function rejectTransfer(transferId) {
            if (window.appLogger) window.appLogger.info('Reject transfer:', transferId); else console.log('Reject transfer:', transferId);
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function exportUsers() {
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
    </script>
</body>
</html>