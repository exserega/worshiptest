<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω</title>
</head>
<body>
    <h1>–†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–º–µ–Ω –≤ —Å–æ–±—ã—Ç–∏—è—Ö</h1>
    <p>–≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –∏–º–µ–Ω–∏ –≤–æ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏—è—Ö.</p>
    
    <button id="syncBtn" onclick="runSync()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é</button>
    
    <div id="result"></div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase -->
    <script type="module" src="../firebase-init.js"></script>
    
    <script>
        let currentUser = null;
        
        // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        setTimeout(() => {
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUser = {
                            ...userDoc.data(),
                            uid: user.uid
                        };
                        document.getElementById('result').innerHTML = 
                            `<p>–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUser.name} (${currentUser.email})</p>`;
                    }
                } else {
                    document.getElementById('result').innerHTML = 
                        '<p style="color: red;">–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É!</p>';
                }
            });
        }, 1000);
        
        async function runSync() {
            if (!currentUser) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!');
                return;
            }
            
            const btn = document.getElementById('syncBtn');
            btn.disabled = true;
            btn.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            
            try {
                const db = firebase.firestore();
                const userId = currentUser.uid;
                const newName = currentUser.name;
                
                console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è:', { userId, newName });
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ª–∏–¥–µ—Ä
                const leaderEventsSnapshot = await db.collection('events')
                    .where('leaderId', '==', userId)
                    .get();
                    
                // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
                const allEventsSnapshot = await db.collection('events').get();
                
                const batch = db.batch();
                let updateCount = 0;
                let details = [];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–¥–µ –ª–∏–¥–µ—Ä
                leaderEventsSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        leaderName: newName,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    updateCount++;
                    details.push(`–õ–∏–¥–µ—Ä –≤ —Å–æ–±—ã—Ç–∏–∏: ${doc.data().name}`);
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–¥–µ —É—á–∞—Å—Ç–Ω–∏–∫
                allEventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    let needsUpdate = false;
                    const updatedParticipants = {};
                    
                    if (eventData.participants) {
                        Object.entries(eventData.participants).forEach(([key, participant]) => {
                            if (participant.userId === userId) {
                                updatedParticipants[key] = {
                                    ...participant,
                                    userName: newName
                                };
                                needsUpdate = true;
                            } else {
                                updatedParticipants[key] = participant;
                            }
                        });
                        
                        if (needsUpdate) {
                            batch.update(doc.ref, {
                                participants: updatedParticipants,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            updateCount++;
                            details.push(`–£—á–∞—Å—Ç–Ω–∏–∫ –≤ —Å–æ–±—ã—Ç–∏–∏: ${eventData.name}`);
                        }
                    }
                });
                
                if (updateCount > 0) {
                    await batch.commit();
                    document.getElementById('result').innerHTML += 
                        `<p style="color: green;">‚úÖ –£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ ${updateCount} —Å–æ–±—ã—Ç–∏–π!</p>
                         <ul>${details.map(d => `<li>${d}</li>`).join('')}</ul>`;
                } else {
                    document.getElementById('result').innerHTML += 
                        '<p>–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.</p>';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('result').innerHTML += 
                    `<p style="color: red;">‚ùå –û—à–∏–±–∫–∞: ${error.message}</p>`;
            } finally {
                btn.disabled = false;
                btn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é';
            }
        }
    </script>
</body>
</html>