<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link rel="stylesheet" href="css/admin.css">
    
    <!-- Firebase SDK 8.10.0 - –∫–∞–∫ –≤ settings.html -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö -->
    <div id="error-container" style="display: none;">
        <div class="error-message">
            <h1>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1>
            <p id="error-text">–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</p>
            <a href="/login.html" class="button">–í–æ–π—Ç–∏</a>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ -->
    <div id="admin-container" style="display: none;">
        <header class="admin-header">
            <button class="back-button" onclick="history.back()">
                <i class="fas fa-arrow-left"></i>
                –ù–∞–∑–∞–¥
            </button>
            <h1>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <div class="header-info">
                <span id="admin-name"></span>
                <span id="admin-role" class="badge"></span>
            </div>
        </header>

        <!-- –¢–∞–±—ã -->
        <nav class="admin-tabs">
            <button class="tab-button active" data-tab="users">
                <i class="fas fa-users"></i>
                <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
            </button>
            <button class="tab-button" data-tab="branches">
                <i class="fas fa-building"></i>
                <span>–§–∏–ª–∏–∞–ª—ã</span>
            </button>
            <button class="tab-button" data-tab="transfers">
                <i class="fas fa-exchange-alt"></i>
                <span>–ü–µ—Ä–µ–≤–æ–¥—ã</span>
            </button>
            <button class="tab-button" data-tab="requests">
                <i class="fas fa-user-plus"></i>
                <span>–ó–∞—è–≤–∫–∏</span>
            </button>
        </nav>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–∞–±–æ–≤ -->
        <main class="admin-content">
            <!-- –¢–∞–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <section id="users-tab" class="tab-content active">
                <div class="controls-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...">
                    </div>
                    <div class="filters">
                        <select id="role-filter">
                            <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                            <option value="moderator">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</option>
                            <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                        </select>
                        <select id="status-filter">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="pending">–û–∂–∏–¥–∞—é—â–∏–µ</option>
                            <option value="banned">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                        </select>
                        <select id="branch-filter">
                            <option value="">–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</option>
                        </select>
                    </div>
                    <button class="button" onclick="exportUsers()">
                        <i class="fas fa-download"></i>
                        –≠–∫—Å–ø–æ—Ä—Ç CSV
                    </button>
                </div>
                <div id="users-list" class="users-grid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
                </div>
            </section>

            <!-- –¢–∞–± —Ñ–∏–ª–∏–∞–ª–æ–≤ -->
            <section id="branches-tab" class="tab-content">
                <div class="controls-bar" id="branches-controls">
                    <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞ -->
                </div>
                <div id="branches-list" class="branches-grid">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤...</div>
                </div>
            </section>

            <!-- –¢–∞–± –ø–µ—Ä–µ–≤–æ–¥–æ–≤ -->
            <section id="transfers-tab" class="tab-content">
                <div class="controls-bar">
                    <div class="info-text">
                        <i class="fas fa-info-circle"></i>
                        –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Ñ–∏–ª–∏–∞–ª–∞–º–∏
                    </div>
                </div>
                <div id="transfers-list" class="transfers-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
                </div>
            </section>
            
            <!-- –¢–∞–± –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
            <section id="requests-tab" class="tab-content">
                <div class="controls-bar">
                    <div class="info-text">
                        <i class="fas fa-info-circle"></i>
                        –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Ñ–∏–ª–∏–∞–ª—ã
                    </div>
                    <div class="filters">
                        <select id="request-type-filter">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã –∑–∞—è–≤–æ–∫</option>
                            <option value="branch_join">–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Ñ–∏–ª–∏–∞–ª</option>
                            <option value="branch_create">–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞</option>
                        </select>
                    </div>
                </div>
                <div id="requests-list" class="requests-list">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</div>
                </div>
            </section>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="modals-container"></div>

    <!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script>
        // ====================================
        // FIREBASE INITIALIZATION
        // ====================================
        
        // Firebase configuration - –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –ø—Ä–æ–µ–∫—Ç —á—Ç–æ –∏ –≤ settings.html!
        const firebaseConfig = {
            apiKey: "AIzaSyBlkjVQFtFpMRFexAi6nBqEkIfjFlU5cDo",
            authDomain: "song-archive-389a6.firebaseapp.com",
            projectId: "song-archive-389a6",
            storageBucket: "song-archive-389a6.appspot.com",
            messagingSenderId: "660585697058",
            appId: "1:660585697058:web:7ceacf752ce6b21ad8fb40",
            measurementId: "G-Z6QYH5YD2E"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º persistence –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('‚úÖ Firebase persistence set to LOCAL');
            })
            .catch((error) => {
                console.error('Error setting persistence:', error);
            });

        // ====================================
        // GLOBAL STATE
        // ====================================
        
        let currentUser = null;
        let currentTab = 'users';
        let branches = [];
        let users = [];
        let transfers = [];
        let requests = []; // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –∑–∞—è–≤–æ–∫
        let isRootAdmin = false;

        // ====================================
        // AUTH CHECK AND INITIALIZATION
        // ====================================
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ - –∫–∞–∫ –≤ settings.js
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üî• Admin page loading...');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            auth.onAuthStateChanged(async (user) => {
                console.log('üîê Auth state changed:', user ? user.email : 'No user');
                
                if (!user) {
                    console.log('‚ùå Not authenticated, showing error');
                    showError('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                    return;
                }
                
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        console.log('‚ùå User profile not found');
                        showError('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    currentUser = { id: user.uid, ...userData };
                    
                    console.log('‚úÖ User profile loaded:', currentUser);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    if (userData.role !== 'admin') {
                        console.log('‚ùå User is not admin:', userData.role);
                        showError('–¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å–Ω–æ–≤–∞—Ç–µ–ª–µ–º
                    isRootAdmin = userData.isFounder || userData.isRootAdmin || false;
                    console.log('‚úÖ Admin access granted, isRootAdmin:', isRootAdmin);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                    document.getElementById('error-container').style.display = 'none';
                    document.getElementById('admin-container').style.display = 'block';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                    updateAdminInfo(user, isRootAdmin);
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
                    initAdminPanel(user, isRootAdmin);
                    
                } catch (error) {
                    console.error('‚ùå Error loading admin panel:', error);
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
                }
            });
        });

        // ====================================
        // UI FUNCTIONS
        // ====================================
        
        function showError(message) {
            document.getElementById('error-container').style.display = 'flex';
            document.getElementById('admin-container').style.display = 'none';
            document.getElementById('error-text').textContent = message;
        }
        
        function updateAdminInfo(user, isRootAdmin) {
            document.getElementById('admin-name').textContent = user.displayName || user.email;
            const roleEl = document.getElementById('admin-role');
            roleEl.textContent = isRootAdmin ? '–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å' : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            roleEl.className = 'badge ' + (isRootAdmin ? 'badge-danger' : 'badge-warning');
        }

        // ====================================
        // ADMIN PANEL INITIALIZATION
        // ====================================
        
        async function initAdminPanel(user, isRootAdmin) {
            console.log('üöÄ Initializing admin panel...');
            
            try {
                // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
                const { initAdminPanel: initAdminCore } = await import('./src/modules/admin/adminCore.js');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                await import('./src/modules/admin/notifications.js');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å —Å –º–æ–¥—É–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
                await initAdminCore(user, isRootAdmin);
                
                console.log('‚úÖ Admin panel modules loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading admin modules:', error);
                
                // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É –µ—Å–ª–∏ –º–æ–¥—É–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                console.log('‚ö†Ô∏è Falling back to inline initialization...');
                await                     initAdminPanelFallback(user, isRootAdmin);
            }
        }
        
        // –†–µ–∑–µ—Ä–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
        async function initAdminPanelFallback(user, isRootAdmin) {
            console.log('üöÄ Initializing admin panel (fallback)...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            await Promise.all([
                loadBranches(),
                loadUsers(),
                loadTransfers(),
                loadRequests() // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∑–∞—è–≤–æ–∫
            ]);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventHandlers();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞–±
            showTab('users');
        }
        
        // ====================================
        // DATA LOADING
        // ====================================
        
        async function loadBranches() {
            try {
                const snapshot = await db.collection('branches').get();
                branches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('‚úÖ Loaded branches:', branches.length);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ñ–∏–ª–∏–∞–ª–æ–≤
                updateBranchFilter();
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã
                displayBranches();
            } catch (error) {
                console.error('Error loading branches:', error);
            }
        }
        
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('‚úÖ Loaded users:', users.length);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                displayUsers();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function loadTransfers() {
            try {
                const snapshot = await db.collection('transferRequests')
                    .where('status', '==', 'pending')
                    .get();
                transfers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('‚úÖ Loaded transfers:', transfers.length);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏
                displayTransfers();
            } catch (error) {
                console.error('Error loading transfers:', error);
            }
        }
        
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
        async function loadRequests() {
            try {
                const snapshot = await db.collection('requests')
                    .where('status', '==', 'pending')
                    .get();
                requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('‚úÖ Loaded requests:', requests.length);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞—è–≤–∫–∏
                displayRequests();
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }
        
        // ====================================
        // UI DISPLAY FUNCTIONS
        // ====================================
        
        function displayUsers() {
            const container = document.getElementById('users-list');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                return;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            let filteredUsers = [...users];
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏
            const roleFilter = document.getElementById('role-filter').value;
            if (roleFilter) {
                filteredUsers = filteredUsers.filter(u => u.role === roleFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            const statusFilter = document.getElementById('status-filter').value;
            if (statusFilter) {
                filteredUsers = filteredUsers.filter(u => u.status === statusFilter);
            }
            
            // –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–∏–ª–∏–∞–ª—É
            const branchFilter = document.getElementById('branch-filter').value;
            if (branchFilter) {
                filteredUsers = filteredUsers.filter(u => u.branchId === branchFilter);
            }
            
            // –ü–æ–∏—Å–∫
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            if (searchTerm) {
                filteredUsers = filteredUsers.filter(u => 
                    (u.name && u.name.toLowerCase().includes(searchTerm)) ||
                    (u.email && u.email.toLowerCase().includes(searchTerm)) ||
                    (u.phone && u.phone.includes(searchTerm))
                );
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            container.innerHTML = filteredUsers.map(user => `
                <div class="user-card">
                    <div class="user-header">
                        <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="${user.name}" class="user-avatar">
                        <div class="user-info">
                            <h3>${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</h3>
                            <p>${user.email || user.phone || '–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤'}</p>
                        </div>
                    </div>
                    <div class="user-badges">
                        <span class="badge badge-${getRoleBadgeClass(user.role)}">${getRoleText(user.role)}</span>
                        <span class="badge badge-${getStatusBadgeClass(user.status)}">${getStatusText(user.status)}</span>
                        ${user.branchId ? `<span class="badge">${getBranchName(user.branchId)}</span>` : ''}
                    </div>
                    <div class="user-actions">
                        <button class="button small" onclick="editUser('${user.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${isRootAdmin && user.id !== currentUser.id ? `
                            <button class="button small danger" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function displayBranches() {
            const container = document.getElementById('branches-list');
            
            if (branches.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç —Ñ–∏–ª–∏–∞–ª–æ–≤</div>';
                return;
            }
            
            container.innerHTML = branches.map(branch => `
                <div class="branch-card">
                    <h3>${branch.name}</h3>
                    <p>${branch.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <div class="branch-stats">
                        <span><i class="fas fa-users"></i> ${getUsersInBranch(branch.id)} —á–µ–ª–æ–≤–µ–∫</span>
                    </div>
                    <div class="branch-actions">
                        <button class="button small" onclick="editBranch('${branch.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${isRootAdmin ? `
                            <button class="button small danger" onclick="deleteBranch('${branch.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function displayTransfers() {
            const container = document.getElementById('transfers-list');
            
            if (transfers.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–µ—Ä–µ–≤–æ–¥</div>';
                return;
            }
            
            container.innerHTML = transfers.map(transfer => `
                <div class="transfer-card">
                    <div class="transfer-info">
                        <h4>${getUserName(transfer.userId)}</h4>
                        <p>–ò–∑: ${getBranchName(transfer.fromBranchId)} ‚Üí –í: ${getBranchName(transfer.toBranchId)}</p>
                        <p class="transfer-reason">${transfer.reason}</p>
                        <small>–ü–æ–¥–∞–Ω–∞: ${formatDate(transfer.createdAt)}</small>
                    </div>
                    <div class="transfer-actions">
                        <button class="button small success" onclick="approveTransfer('${transfer.id}')">
                            <i class="fas fa-check"></i> –û–¥–æ–±—Ä–∏—Ç—å
                        </button>
                        <button class="button small danger" onclick="rejectTransfer('${transfer.id}')">
                            <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
        function displayRequests() {
            const container = document.getElementById('requests-list');
            
            if (requests.length === 0) {
                container.innerHTML = '<div class="empty-state">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>';
                return;
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
            let filteredRequests = [...requests];
            const requestTypeFilter = document.getElementById('request-type-filter').value;
            if (requestTypeFilter) {
                filteredRequests = filteredRequests.filter(r => r.type === requestTypeFilter);
            }

            container.innerHTML = filteredRequests.map(request => {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
                const user = users.find(u => u.id === request.userId);
                const userName = user ? user.name || user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                if (request.type === 'branch_join') {
                    const branch = branches.find(b => b.id === request.branchId);
                    const branchName = branch ? branch.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª';
                    
                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <h4>${userName}</h4>
                                <span class="badge info">–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ —Ñ–∏–ª–∏–∞–ª</span>
                            </div>
                            <div class="request-info">
                                <p><i class="fas fa-building"></i> –§–∏–ª–∏–∞–ª: <strong>${branchName}</strong></p>
                                ${request.userData ? `
                                    <p><i class="fas fa-envelope"></i> Email: ${request.userData.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    <p><i class="fas fa-phone"></i> –¢–µ–ª–µ—Ñ–æ–Ω: ${request.userData.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                ` : ''}
                                <small><i class="fas fa-clock"></i> –ü–æ–¥–∞–Ω–∞: ${formatDate(request.createdAt)}</small>
                            </div>
                            <div class="request-actions">
                                <button class="button small success" onclick="approveJoinRequest('${request.id}', '${request.userId}', '${request.branchId}')">
                                    <i class="fas fa-check"></i> –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                <button class="button small danger" onclick="rejectRequest('${request.id}')">
                                    <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                } else if (request.type === 'branch_create') {
                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <h4>${userName}</h4>
                                <span class="badge warning">–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞</span>
                            </div>
                            <div class="request-info">
                                <p><i class="fas fa-building"></i> –ù–∞–∑–≤–∞–Ω–∏–µ: <strong>${request.branchData.name}</strong></p>
                                <p><i class="fas fa-map-marker-alt"></i> –ì–æ—Ä–æ–¥: ${request.branchData.city}</p>
                                ${request.branchData.address ? `<p><i class="fas fa-location-arrow"></i> –ê–¥—Ä–µ—Å: ${request.branchData.address}</p>` : ''}
                                ${request.branchData.contactPhone ? `<p><i class="fas fa-phone"></i> –¢–µ–ª–µ—Ñ–æ–Ω: ${request.branchData.contactPhone}</p>` : ''}
                                ${request.branchData.contactSocial ? `<p><i class="fas fa-comment"></i> –°–æ—Ü—Å–µ—Ç—å: ${request.branchData.contactSocial}</p>` : ''}
                                <small><i class="fas fa-clock"></i> –ü–æ–¥–∞–Ω–∞: ${formatDate(request.createdAt)}</small>
                            </div>
                            <div class="request-actions">
                                <button class="button small success" onclick="approveBranchCreation('${request.id}', '${request.userId}')">
                                    <i class="fas fa-check"></i> –°–æ–∑–¥–∞—Ç—å —Ñ–∏–ª–∏–∞–ª
                                </button>
                                <button class="button small danger" onclick="rejectRequest('${request.id}')">
                                    <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                }
                return '';
            }).join('');
        }
        
        // ====================================
        // EVENT HANDLERS
        // ====================================
        
        function setupEventHandlers() {
            // –¢–∞–±—ã
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.dataset.tab;
                    showTab(tab);
                });
            });
            
            // –§–∏–ª—å—Ç—Ä—ã
            document.getElementById('role-filter').addEventListener('change', displayUsers);
            document.getElementById('status-filter').addEventListener('change', displayUsers);
            document.getElementById('branch-filter').addEventListener('change', displayUsers);
            document.getElementById('user-search').addEventListener('input', displayUsers);
            
            // –§–∏–ª—å—Ç—Ä –¥–ª—è –∑–∞—è–≤–æ–∫
            const requestTypeFilter = document.getElementById('request-type-filter');
            if (requestTypeFilter) {
                requestTypeFilter.addEventListener('change', displayRequests);
            }
        }
        
        function showTab(tabName) {
            currentTab = tabName;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}-tab`);
            });
        }
        
        // ====================================
        // HELPER FUNCTIONS
        // ====================================
        
        function getRoleBadgeClass(role) {
            const classes = {
                admin: 'danger',
                moderator: 'warning',
                user: 'info'
            };
            return classes[role] || 'secondary';
        }
        
        function getRoleText(role) {
            const texts = {
                admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                moderator: '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä',
                user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
            };
            return texts[role] || role;
        }
        
        function getStatusBadgeClass(status) {
            const classes = {
                active: 'success',
                pending: 'warning',
                banned: 'danger'
            };
            return classes[status] || 'secondary';
        }
        
        function getStatusText(status) {
            const texts = {
                active: '–ê–∫—Ç–∏–≤–µ–Ω',
                pending: '–û–∂–∏–¥–∞–µ—Ç',
                banned: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'
            };
            return texts[status] || status;
        }
        
        function getBranchName(branchId) {
            const branch = branches.find(b => b.id === branchId);
            return branch ? branch.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∏–ª–∏–∞–ª';
        }
        
        function getUserName(userId) {
            const user = users.find(u => u.id === userId);
            return user ? user.name || user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        
        function getUsersInBranch(branchId) {
            return users.filter(u => u.branchId === branchId).length;
        }
        
        function formatDate(timestamp) {
            if (!timestamp) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('ru-RU');
        }
        
        function updateBranchFilter() {
            const select = document.getElementById('branch-filter');
            select.innerHTML = '<option value="">–í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</option>' +
                branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
        }
        
        // ====================================
        // ACTION FUNCTIONS (–∑–∞–≥–ª—É—à–∫–∏)
        // ====================================
        
        function editUser(userId) {
            console.log('Edit user:', userId);
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function deleteUser(userId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
                console.log('Delete user:', userId);
                alert('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            }
        }
        
        function editBranch(branchId) {
            console.log('Edit branch:', branchId);
            alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function deleteBranch(branchId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª–∏–∞–ª?')) {
                console.log('Delete branch:', branchId);
                alert('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            }
        }
        
        function showCreateBranchModal() {
            alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function approveTransfer(transferId) {
            console.log('Approve transfer:', transferId);
            alert('–§—É–Ω–∫—Ü–∏—è –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function rejectTransfer(transferId) {
            console.log('Reject transfer:', transferId);
            alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }
        
        function exportUsers() {
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }

        // ====================================
        // REQUEST HANDLERS
        // ====================================
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
        async function approveJoinRequest(requestId, userId, branchId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ?')) {
                try {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É
                    await db.collection('requests').doc(requestId).update({
                        status: 'approved',
                        approvedBy: currentUser.id,
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await db.collection('users').doc(userId).update({
                        status: 'active',
                        branchId: branchId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('Join request approved:', requestId);
                    await loadRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
                    await loadUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    showSuccess('–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.');
                } catch (error) {
                    console.error('Error approving join request:', error);
                    showError('–û—à–∏–±–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ' + error.message);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
        async function approveBranchCreation(requestId, userId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª–∏–∞–ª?')) {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
                    const requestDoc = await db.collection('requests').doc(requestId).get();
                    const requestData = requestDoc.data();
                    const branchData = requestData.branchData;
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∏–ª–∏–∞–ª
                    const branchRef = await db.collection('branches').add({
                        name: branchData.name,
                        city: branchData.city,
                        address: branchData.address || '',
                        contactPhone: branchData.contactPhone || '',
                        contactSocial: branchData.contactSocial || '',
                        createdBy: userId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫—É
                    await db.collection('requests').doc(requestId).update({
                        status: 'approved',
                        approvedBy: currentUser.id,
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBranchId: branchRef.id
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –¥–µ–ª–∞–µ–º –µ–≥–æ –∞–¥–º–∏–Ω–æ–º –Ω–æ–≤–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
                    await db.collection('users').doc(userId).update({
                        status: 'active',
                        role: 'admin',
                        branchId: branchRef.id,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('Branch created:', branchRef.id);
                    await Promise.all([
                        loadRequests(),
                        loadBranches(),
                        loadUsers()
                    ]);
                    showSuccess('–§–∏–ª–∏–∞–ª —Å–æ–∑–¥–∞–Ω! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ñ–∏–ª–∏–∞–ª–∞.');
                } catch (error) {
                    console.error('Error creating branch:', error);
                    showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞: ' + error.message);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏
        async function rejectRequest(requestId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?')) {
                try {
                    await db.collection('requests').doc(requestId).update({
                        status: 'rejected',
                        rejectedBy: currentUser.id,
                        rejectedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Request rejected:', requestId);
                    loadRequests(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
                    showSuccess('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!');
                } catch (error) {
                    console.error('Error rejecting request:', error);
                    showError('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ' + error.message);
                }
            }
        }

        // ====================================
        // UTILITIES
        // ====================================
        
        function showSuccess(message) {
            alert(message); // TODO: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        }
        
        function showError(message) {
            alert('–û—à–∏–±–∫–∞: ' + message); // TODO: –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        }
        
        // ====================================
        // INITIALIZE
        // ====================================
        
        initAdminPanel();
    </script>
</body>
</html>