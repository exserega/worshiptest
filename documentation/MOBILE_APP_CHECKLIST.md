## Чек‑лист подготовки мобильного приложения (Capacitor) для Agape Worship

Цель: упаковать текущее веб‑приложение в нативные оболочки Android и iOS без ломки логики (Firebase v8 сохраняем), с корректной авторизацией в WebView и соответствием требованиям Google Play и App Store.

### 0. Предварительно (сделано/проверить)
- [ ] Производительность оптимизирована (на текущем уровне): preconnect, кэш в sessionStorage, параллелизация инициализаций, ленивый worker, отложенная загрузка данных архива
- [ ] UI/UX: соблюдение тёмной темы, контрастность, кнопки/иконки на тёмном фоне соответствуют правилам
- [ ] PWA/SW не конфликтуют с WebView (SW остаётся для веба; в нативной оболочке его влияние минимально)

### 1. Подготовка репозитория
- [ ] Создать ветку/теги для мобильного релиза (работаем в main по требованию заказчика)
- [ ] Зафиксировать версии зависимостей в `package.json`

### 2. Инициализация Capacitor
- [ ] Добавить Capacitor в проект: `npm i @capacitor/core @capacitor/cli -D`
- [ ] Инициализация: `npx cap init "Agape Worship" com.agapeworship.app --web-dir=.`
- [ ] Проверить, что `capacitor.config.ts|json` указывает на корень (webDir: ".") и стартовую страницу `index.html`

### 3. Плагины и платформы
- [ ] Установить базовые плагины: `@capacitor/app`, `@capacitor/splash-screen`, `@capacitor/browser`
- [ ] Добавить Android: `npx cap add android`
- [ ] Добавить iOS: `npx cap add ios`
- [ ] Синхронизация после изменений: `npx cap sync`

### 4. Ассеты (иконки/сплэш)
- [ ] Подготовить базовые SVG/PNG логотипов с тёмным фоном и контрастным текстом
- [ ] Установить `@capacitor/assets` и сгенерировать ассеты: `npx @capacitor/assets generate`
- [ ] Проверить адаптивность и видимость на тёмном фоне согласно правилам проекта

### 5. Авторизация в WebView
- [ ] Перевести запуск входа в режиме WebView на `signInWithRedirect` для Google/Apple (в браузере оставить popup)
- [ ] Добавить схему/редиректы для iOS/Android (например, `com.agapeworship.app://auth-callback`)
- [ ] В Firebase Console:
  - [ ] Добавить разрешённые домены и URI редиректа для iOS/Android
  - [ ] Проверить поддержку Google/Apple Sign-In (для iOS потребуется Apple Sign-In, для публикации)
- [ ] Точечно править `src/modules/auth/login.js`: ветка для WebView определяет использование Redirect

Подробности OAuth/redirect (для настройки в Firebase Console):
- Разрешённые домены аутентификации:
  - `agapeworship.asia` (основной домен приложения)
  - `song-archive-389a6.firebaseapp.com` (authDomain из конфига Firebase)
- Google OAuth: Authorised redirect URIs (в экране провайдера Google)
  - `https://song-archive-389a6.firebaseapp.com/__/auth/handler`
  - (опционально, если используем пользовательский домен): `https://agapeworship.asia/__/auth/handler`
- Apple Sign-In:
  - Service ID: зарегистрировать на Apple Developer
  - Return URLs: те же Redirect URIs (Firebase handler), либо свои URL на домене
  - Настроить Email/Name scopes и связку с Firebase

Важно: При использовании нативной оболочки (Capacitor) сначала проверяем `signInWithRedirect` внутри WebView. Если провайдер блокирует WebView/Third‑party cookies на iOS, используем `@capacitor/browser` для открытия внешнего браузера и возврат по redirect URI (потребуется схема и intercept) — это advanced‑путь; исполним после первичных тестов.

### 6. Конфигурации платформ
- Android (AndroidManifest.xml / strings.xml):
  - [ ] Указать intent-filter для схемы редиректа
  - [ ] Настроить `android:exported` согласно требованиям Play
- iOS (Info.plist):
  - [ ] LSApplicationQueriesSchemes / URL Types для редирект‑схемы
  - [ ] Конфиг для Sign in with Apple (если используется)

### 7. Сборка и отладка
- [ ] `npx cap open android` → собрать debug, протестировать: логин, поиск, сет‑листы, архив, события, презентация
- [ ] `npx cap open ios` → собрать debug, протестировать те же сценарии (особенно авторизацию)
- [ ] Проверить, что guest/pending ограничения работают одинаково
- [ ] Проверить отсутствие крашей при офлайн/плохой сети

### 8. Политики магазинов и соответствие
- [ ] Политика приватности и экран first‑run (ссылка на сайт)
- [ ] Обоснование доступа к сети, хранению (минимально, без лишних пермишенов)
- [ ] Для iOS: поддержка Apple Sign-In (если требование релевантно флоу), иконки/скриншоты
- [ ] Для Google Play: контент‑политики, целевое API уровня Android, 64‑бит, заявления о сборе данных (Data Safety)

### 9. Релизные сборки
- [ ] Android: подпись, bundle (.aab), загрузка в Play Console (internal testing)
- [ ] iOS: архив в Xcode, TestFlight (internal) → App Store review

### 10. Риски/нюансы текущего приложения
- Firebase v8 (немодульный) — оставляем, совместимость ok, важно: редиректы и разрешённые домены для WebView
- PWA SW — в нативной оболочке влияние на навигацию минимально; не требуется отключение, но тестируем edge‑кейсы
- Тёмная тема — строгое соблюдение контрастов (#1a1f2e/#1f2937/#111827 фоны, #e5e7eb/#9ca3af текст/иконки)
- Гостевой/ожидает подтверждения — все guard’ы уже внедрены в вебе; в WebView поведение идентичное

### 11. Что уже сделали (будем дополнять по ходу)
- [x] Оптимизация: preconnect/dns‑prefetch, метрики Performance API
- [x] Параллелизация инициализаций, ленивая инициализация SearchWorker
- [x] Отложенная загрузка пользователей архивных сортировок
- [x] sessionStorage‑кэш песен и выбранного филиала (в рамках вкладки)
- [x] Снижение шума логов опциональных элементов

### 12. Следующие шаги (исполнение)
1) Добавить скрипты и конфиги Capacitor (Android/iOS)
2) Внести правки в `login.js` (ветка WebView → Redirect)
3) Настроить redirect URI в Firebase
4) Сгенерировать ассеты (иконки/сплэш)
5) Собрать и протестировать на устройстве Android, затем iOS
6) Подготовить страницы в магазинах и метаданные, запустить внутреннее тестирование

— Этот файл будем пополнять по мере выполнения задач, фиксируя детали и решения.

