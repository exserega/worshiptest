# Agape Worship — локальная разработка и PWA‑памятка

## Локальный запуск (Windows PowerShell)
- Перейти в папку проекта:
  - `cd "C:\Users\BM DESIGN\Desktop\Worship site\worshiptest-main"`
- Запустить сервер:
  - `py -m http.server 8001`
- Открыть в браузере:
  - Главная: `http://localhost:8001/`
  - Логин: `http://localhost:8001/public/login.html`
  - Настройки: `http://localhost:8001/public/settings.html`
  - Админ: `http://localhost:8001/public/admin.html`

Примечание: в PowerShell не используйте `&&`. Команды выполнять по очереди.

## Firebase инициализация (единая)
- На всех страницах в `public/` подключается только общий `firebase-init.js` (без дублирующих конфигов).
- Порядок: сначала CDN SDK v8 (если нужно), затем `firebase-init.js`, затем ваши модули.

## Service Worker (PWA)
- Текущая версия: v6327
- При изменении путей/критичных ресурсов — ОБЯЗАТЕЛЬНО увеличьте `CACHE_NAME` в `sw.js`.
- После обновления: в браузере DevTools → Application → Clear storage → Clear site data → перезагрузить страницу.

## Важно: работа с инструментами
- При возникновении ошибок инструментов (Tool call failed) — сразу прерывайте работу и начинайте заново.
- Всегда проверяйте соединение командой `echo "Test"` перед продолжением.
- Если инструменты не работают несколько раз подряд — подождите и попробуйте снова.

## Мобильное приложение (TWA)
- Изменения сайта (HTML/CSS/JS) после деплоя на `agapeworship.asia` попадают в приложение автоматически.
- APK/AAB пересобирать НЕ нужно для контент‑изменений. Обязательно повышайте версию кэша в `sw.js`.
- Адресная строка в TWA исчезает при корректном `/.well-known/assetlinks.json` (см. `documentation/MOBILE_RELEASE_GUIDE.md`).

## Офлайн режим
- Включена офлайн‑персистентность Firestore; ранее загруженные песни/списки/репертуар доступны офлайн.
- При отсутствии сети чтение идёт из кэша; изменения (запись) выполняются только онлайн.

## Мобильная адаптация
- Используйте CSS псевдо-селектор `:has()` для условной логики стилей
- Для исправления двойной прокрутки на мобильных:
  ```css
  @media (max-width: 768px) {
      body:has(.specific-class) {
          overflow: auto;
      }
      body:has(.specific-class) .container {
          height: auto;
          overflow: visible;
      }
  }
  ```

## UI компоненты и стиль
- Основной цвет акцента: `#00b2bc` (бирюзовый)
- Используйте полупрозрачные фоны: `rgba(255, 255, 255, 0.05)`
- Эффект размытия фона: `backdrop-filter: blur(20px)`
- Радиусы скругления: 8px для кнопок, 12px для модальных окон
- Переходы: `transition: all 0.2s ease`
- **ВАЖНО**: См. `documentation/STYLE_GUIDE.md` для полного руководства по стилям и дизайну

## Диагностика
- Если видите `Firebase: No Firebase App '[DEFAULT]'` — проверьте, что `firebase-init.js` загружается раньше модулей страницы.
- Сообщения вида `Unchecked runtime.lastError: The message port closed...` приходят от расширений браузера и не относятся к сайту.

## Логи
- Для логов используйте `src/utils/logger.js`. На localhost логи видны, в продакшене — скрыты.
- Для отладки копирования текста на главной добавлены логи вида `[Copy] ...`.

## Календарь событий
- Страница: `/public/events/` 
- Компоненты:
  - `events-calendar.js` — основная логика календаря и отображения событий
  - `eventCreationModal.js` — модальное окно создания/редактирования событий
  - `eventsApi.js` — взаимодействие с Firebase для событий
- Режимы отображения: сетка календаря и список событий
- Поддерживает создание, редактирование, удаление событий
- Участники событий могут быть как зарегистрированными пользователями, так и введенными вручную
- **Новые возможности (январь 2025)**:
  - Улучшенный дизайн карточек в режиме списка
  - Интерактивный разворачивающийся список участников
  - Создатель события не добавляется автоматически в участники
  - Корректная передача даты из календаря в модальное окно
  - Навигация по месяцам свайпами влево/вправо на мобильных устройствах

## Интеграция сет-листов с событиями (Декабрь 2024)
- **Кнопка добавления в календарь**: Появляется в панели сет-листов для admin/moderator
- **Выбор даты**: Стильный темный календарь с минималистичным дизайном
- **Автоматическая проверка событий**: Поиск существующих событий на выбранную дату
- **Гибкие сценарии**:
  - Создание нового события с предвыбранным сет-листом
  - Замена сет-листа в существующем событии (с подтверждением)
  - Выбор из нескольких событий через кликабельные карточки
- **См. документацию**: `/documentation/SETLIST_EVENT_INTEGRATION_GUIDE.md`

## Работа с иконками и темами (обновлено)
- Используется Font Awesome 6. На темном фоне иконки/текст ДОЛЖНЫ быть светлыми, на голубом фоне — темными (см. STYLE_GUIDE и критические правила цветов).
- SVG иконки используют `currentColor` для наследования цвета.

## Поиск (обновлено)
- Стандартизированная кнопка очистки (крестик): 32x32, без padding, центрирование иконки; при появлении крестика лупа скрывается.
- Главный поиск на главной использует ранжирование с приоритетом совпадений по НАЗВАНИЮ, затем по тексту (`searchSongsWithCache`).
- В оверлеях (добавление песен, архив, создание события) поведение аналогично; в архиве и оверлеях лупа автоматически скрывается при показе крестика.

## Копирование текста песни (обновлено)
- Кнопка "Копировать" на главной копирует ИМЕННО видимый контент из `#song-display` (`innerText`).
- Режимы учитываются:
  - "Только аккорды" — копируются только аккорды и заголовки блоков.
  - Аккорды скрыты — копируется только текст и заголовки блоков.
  - Оба включены — копируется всё.

## Заголовки блоков песни (legend)
- На главной странице убраны иконки/эмодзи перед названиями блоков (Куплет, Припев и т.д.); показывается только текст заголовка.

## Коммиты и деплой
- Используйте осмысленные сообщения коммитов:
  - `feat:` — новая функциональность
  - `fix:` — исправление ошибок
  - `refactor:` — изменение кода без изменения функциональности
  - `style:` — изменения стилей/форматирования
- После внесения изменений:
  1. `git add -A` — добавить все изменения
  2. `git commit -m "тип: описание"` — создать коммит
  3. `git push` — отправить на GitHub
  4. GitHub Pages автоматически обновится через 1-2 минуты

## Документация
- `/documentation/AI_AGENT_CRITICAL_GUIDE.md` — критически важная информация для AI агентов
- `/documentation/AI_AGENT_GUIDE.md` — детальное руководство по проекту
- `/documentation/STYLE_GUIDE.md` — руководство по стилям и дизайну
- `/documentation/EVENTS_FEATURE_GUIDE.md` — руководство по функционалу событий
- `/documentation/SETLIST_EVENT_INTEGRATION_GUIDE.md` — интеграция сет-листов с событиями
- `/documentation/ROLES_AND_PERMISSIONS_GUIDE.md` — система ролей и прав доступа
- Страница миграции: `/migrate-repertoire/` — перенос старых репертуаров Vocalists → Users
