<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ–±—ã—Ç–∏—è - Agape Worship</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    
    <!-- PWA -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#1a1a1a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple -->
    <link rel="apple-touch-icon" href="../assets/images/Icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="../styles/buttons.css">
    
    <!-- –°—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π -->
    <link rel="stylesheet" href="./events-page.css">
    
    <!-- Firebase (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script type="module" src="../firebase-init.js"></script>
</head>
<body class="dark-theme">
    <div class="events-page-container">
        <!-- –ë–ª–æ–∫ 1: –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏ -->
        <header class="events-top-bar">
            <button class="icon-button" onclick="window.location.href='/'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <h1 class="month-title" id="monthTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            
            <div class="top-bar-actions">
                <button class="icon-button" id="listViewBtn" title="–°–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π" style="display: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M8 6H21M8 12H21M8 18H21M3 6H3.01M3 12H3.01M3 18H3.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="icon-button" id="createEventBtn" title="–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ" style="display: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </header>
        
        <!-- –ë–ª–æ–∫ 2: –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
        <div class="calendar-section" id="calendarContainer" style="display: none;">
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º -->
            <div class="month-navigation">
                <button class="month-nav-btn" id="prevMonthBtn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M12 5L7 10L12 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="month-nav-btn" id="nextMonthBtn">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M8 5L13 10L8 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            
            <!-- –°–µ—Ç–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
            <div class="calendar-grid">
                <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
                <div class="calendar-weekdays" id="weekdays"></div>
                <!-- –î–Ω–∏ –º–µ—Å—è—Ü–∞ -->
                <div class="calendar-days" id="calendarDays"></div>
            </div>
        </div>
        
        <!-- –ë–ª–æ–∫ 3: –°–æ–±—ã—Ç–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã -->
        <div class="selected-date-events" id="selectedDateEvents">
            <div class="no-date-selected">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–±—ã—Ç–∏–π</p>
            </div>
        </div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="loading-indicator active" id="loadingIndicator">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π...</p>
        </div>
    </div>
    
    <!-- –°–∫—Ä–∏–ø—Ç—ã - –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å settings.html -->
    <script type="module">
        import '../firebase-init.js';
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÖ Events page loading...');
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∫–∞–∫ –≤ settings.js)
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    console.log('‚ùå Not authenticated, redirecting...');
                    window.location.href = '/public/login.html';
                    return;
                }
                
                console.log('‚úÖ User authenticated:', user.email);
                
                try {
                    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏
                    const { checkAuth, getCurrentUser, canManageEvents } = await import('../src/modules/auth/authCheck.js');
                    const logger = (await import('../src/utils/logger.js')).default;
                    
                    // –°–Ω–∞—á–∞–ª–∞ –≤—ã–∑—ã–≤–∞–µ–º checkAuth –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    logger.log('–í—ã–∑—ã–≤–∞–µ–º checkAuth –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                    const authResult = await checkAuth();
                    logger.log('–†–µ–∑—É–ª—å—Ç–∞—Ç checkAuth:', authResult);
                    
                    // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const currentUser = getCurrentUser();
                    logger.log('–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–ª–µ checkAuth:', currentUser);
                    
                    if (!currentUser || !currentUser.branchId) {
                        throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –∏–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª–∏–∞–ª');
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤
                    if (canManageEvents()) {
                        document.getElementById('createEventBtn').style.display = 'flex';
                    }
                    // –ö–Ω–æ–ø–∫–∞ —Å–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º (–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–∫—Ä—ã—Ç–∞)
                    // document.getElementById('listViewBtn').style.display = 'flex';
                    
                    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    const { EventsCalendar } = await import('./events-calendar.js');
                    const calendar = new EventsCalendar();
                    window.eventsCalendar = calendar; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ
                    await calendar.init();
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                    document.getElementById('loadingIndicator').classList.remove('active');
                    document.getElementById('calendarContainer').style.display = 'block';
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π:', error);
                    document.getElementById('loadingIndicator').innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${error.message}
                            </p>
                            <button class="btn-primary" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        </div>
                    `;
                }
            });
        });
    </script>
</body>
</html>